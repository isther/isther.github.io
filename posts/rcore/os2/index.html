<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>rCore-os2-批处理系统 | Ther's Blog -- 个人笔记</title><meta name=keywords content="rCore"><meta name=description content="Desc Text."><meta name=author content="Ther"><link rel=canonical href=https://www.niuwx.cn/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.83c4eb6d61e6a4176992e4a4ce8786fc30bd40032ba8663ec5d11e285a965766.css integrity="sha256-g8TrbWHmpBdpkuSkzoeG/DC9QAMrqGY+xdEeKFqWV2Y=" rel="preload stylesheet" as=style><link rel=icon href=https://www.niuwx.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.niuwx.cn/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.niuwx.cn/favicon.ico><link rel=apple-touch-icon href=https://www.niuwx.cn/favicon.ico><link rel=mask-icon href=https://www.niuwx.cn/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.108.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!1}],throwOnError:!1})})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="rCore-os2-批处理系统"><meta property="og:description" content="Desc Text."><meta property="og:type" content="article"><meta property="og:url" content="https://www.niuwx.cn/posts/rcore/os2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-10T16:33:51+08:00"><meta property="article:modified_time" content="2022-10-10T16:33:51+08:00"><meta property="og:site_name" content="Ther's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="rCore-os2-批处理系统"><meta name=twitter:description content="Desc Text."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.niuwx.cn/posts/"},{"@type":"ListItem","position":2,"name":"rCore","item":"https://www.niuwx.cn/posts/rcore/"},{"@type":"ListItem","position":3,"name":"rCore-os2-批处理系统","item":"https://www.niuwx.cn/posts/rcore/os2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"rCore-os2-批处理系统","name":"rCore-os2-批处理系统","description":"Desc Text.","keywords":["rCore"],"articleBody":"保障系统安全和多应用支持是操作系统的两个核心目标，本章从这两个目标出发，思考如何设计应用程序，并进一步展现操作系统的一系列新功能:\n构造包含操作系统内核和多个应用程序的单一执行程序 通过批处理支持多个程序的自动加载和运行 操作系统利用硬件特权级机制，实现对操作系统自身的保护 实现特权级的跨越 支持跨特权级的系统调用功能 批处理系统(Batch System)，它可以用来管理无需或仅需少量用户交互即可运行的程序，在资源允许的情况下它可以自动安排程序的执行，这被称为批处理作业，此名词源自二十世纪60年代的大型机时代。批处理系统的核心思想是：将多个程序打包到一起输入计算机，当一个程序运行结束后，计算机自动加载下一个程序到内存并执行。\n本片代码:\n代码地址 特权级机制 为了保护我们的批处理系统不受到出错应用程序的影响并全程稳定工作，单凭软件实现是很难做到的，而是需要CPU提供一种特权级隔离机制，使CPU在执行应用程序和操作系统内核的指令时处于不同的特权级。\n特权级的软硬件协同设计 实现特权级机制的根本原因是应用程序运行的安全性不可充分信任。由于操作系统和应用程序两者通过编译器形成一个单一执行程序来执行，导致即使是应用本身的问题，也会牵连操作系统，导致整个计算机系统出现问题。\n所以，计算机科学家和工程师想出了一个办法：让相对安全可靠的操作系统运行在一个硬件保护的安全执行环境中，不受应用程序的破坏；而让应用程序运行在另外一个无法破坏操作系统的受限执行环境中。\n为了确保操作系统的安全，对应用程序而言，需要限制的主要有两个方面：\n应用程序不能访问任意的地址空间 应用程序不能执行某些可能破坏计算机系统的指令 除此之外，还需要确保应用程序能够得到操作系统的服务，即应用程序和操作系统还需要有交互的手段。使得低特权级机制只能做高特权级软件允许它做的，且超出低特权级能力的功能必须寻求高特权级软件的帮助。\n为了实现这样的特权级机制，需要进行软硬件协同设计。一个比较简洁的方法就是，处理器设置两个不同安全等级的执行环境：\n用户态特权级的执行环境 内核态特权级的执行环境 且明确指出可能破坏计算机系统的内核态特权级指令子集，内核态特权级指令子集只能在内核态特权级的执行环境中执行。处理器在执行指令前会进行特权级安全检查，如果在用户态执行环境中执行内核态特权级指令，会产生异常。\n为了让应用程序获得操作系统的函数服务，采用传统的函数调用方(即通常的call和ret指令或指令组合)将会绕过硬件的特权级保护检查。所以可以设计新的机器指令：执行环境调用(Execution Environment Call 简称 ecall)和执行环境返回(Excution Environment Return 简称 eret)\necall：具有用户态到内核态到执行环境切换能力的函数调用指令 eret：具有内核态到用户态的执行环境切换能力的函数返回指令 硬件具有了这样的机制后，还需要操作系统的配合才能最终完成对操作系统自身的保护。\n首先，操作系统需要提供相应的功能代码，能在执行eret前准备和恢复用户态执行应用程序的上下文。 其次，在应用程序调用ecall指令后，能够检查应用程序的系统调用参数，确保参数不会破坏操作系统。 RISC-V特权级架构 RISC-V架构一共定义了4种特权级：\n级别 编码 名称 0 00 用户/应用模式(U, User/Application) 1 01 监督模式(S, Supervistor) 2 10 虚拟监督模式(H, Hypervistor) 3 11 机器模式(M, Machine) 级别数值越大，特权级越高，掌控硬件的能力越强。\n在CPU硬件层面，除了M模式必须存在外，其他模式可以不存在。RISC-V架构中，只有M模式是必须实现的，剩下的特权级则可以根据跑在CPU上应用的实际需求进行调整：\n简单的嵌入式应用只需要实现M模式 带有一定保护能力的嵌入式系统需要实现M/U模式 复杂的多任务系统则需要实现M/S/U模式 到目前为止，H模式特权规范还没有完全制定好 从特权级架构的角度看待执行环境栈：\n其中，白色块表示一层执行环境，黑色块表示相邻两层执行环境之间的接口。其中操作系统内核代码运行在S模式上；应用程序运行在U模式上。\n运行在M模式上的软件被称为监督模式执行环境(SEE, Supervistor Execution Environment)，比如在操作系统运行前负责加载操作系统的Bootloader-RustSBI。站在运行在S模式上的软件视角来看，它的下面也需要一层执行环境支撑，因此被命名为SEE，它需要在相比S模式更高的特权级下运行，一般情况下SEE在M模式上执行。\n执行环境的功能之一是在它支持的上层软件执行之前进行一些初始化工作。之前提到的引导加载程序会在加电之后对整个系统进行初始化，它实际上就是SEE功能的一部分。也就是说在RISC-V架构上的引导加载程序一般运行在M模式上。\n在上一节中，实现了简单的操作系统，它和应用程序全程运行在S模式下，应用程序很容易破坏没有任何保护的执行环境-操作系统。在之后，我们会涉及RISC-V的M/S/U三种特权级：\n应用程序和用户态支持库运行在U模式的最低特权级 操作系统内核运行在S模式特权级，形成支撑应用程序和用户态支持的执行环境 在之前提到的bootloader-RurstSBI实际上是运行在更底层的M模式特权级下的软件，是操作系统内核的执行环境。 执行环境的另一种功能是对上层软件的执行进行监控管理。可以理解为，当上层软件执行出现了一些异常或者特殊情况时，导致需要用到执行环境中提供的功能，因此需要暂停上层软件的执行，转而运行执行环境的代码。\n由于上层软件和执行环境被设计为运行在不同的特权级，这个过程也往往**（不一定）伴随着CPU的特权级切换**。当执行环境的代码运行结束后，我们需要回到上层软件暂停的位置继续执行。在RISC-V架构中，这种与常规控制流不同的异常控制流(ECF, Exception Control Flow)被称为异常(Exception)，在RISC-V语境下的Trap种类之一。\n用户态应用直接触发从用户态到内核态的异常的原因总体上可以分为两种：\n用户态软件为获得内核态操作系统的服务功能而执行特殊指令 在执行某条指令期间发生了错误并被CPU检测到，例如执行了用户态不允许执行的指令或者其他错误 下表是RISC-V特权级规范定义的可能会导致从低特权级到高特权级到各种异常：\nInterrupt Exception Code Description 0 0 Instruction address misaligned 0 1 Instruction access fault 0 2 Illegal instruction 0 3 Breakpoint 0 4 Load address misaligned 0 5 Load access fault 0 6 Stroe/AMO address misaligned 0 7 Store/AMO access fault 0 8 Environment call from U-mode 0 9 Environment call from S-mode 0 11 Environment call from M-mode 0 12 Instruction page fault 0 13 Load page fault 0 15 Stroe/AMO page fault 其中，断点(Breakpoint)和执行环境调用(Enviroment call)两种异常（这种有意而为之的指令称为陷入或trap类指令）是通常在上层软件中执行一条特定的指令触发的：执行ebreak这条指令之后就会触发断点陷入异常；而执行ecall这条指令之后则会随着CPU当前所处特权级而触发不同的异常。\n执行环境调用ecall，这是一种很特殊的陷入类的指令，在之前从特权级架构看待执行环境栈这张图中，相邻两特权级软件之间的接口正是基于这种陷入机制实现的。M模式软件SEE和S模式的内核之间的接口被称为监督模式二进制接口(Supervistor Binary Interface, SBI)，而内核和U模式的应用程序之间的接口被称为应用程序二进制接口(Application Binary Interface, ABI)，它还有一个更加通俗的名字：系统调用(syscall ,System Cal)。而之所以叫做二进制接口，是因为它与高级编程语言的内部调用接口不同，是机器/汇编指令级的一种接口。\n事实上M/S/U三个特权级的软件可分别由不同的编程语言实现。即使是用同一种汇编语言实现，其调用也不是普通的函数调用，而是陷入异常控制流，在该过程中切换CPU特权级。因此只有将接口下降到机器/汇编指令级才能满足其跨高级语言的通用性和灵活性。\n可以看到，在这样的架构之下，每层特权级的软件都只能做高特权级软件允许它做的，并且不会产生什么撼动高特权级软件的情况，一旦低特权级软件的要求超出了其能力范围，就必须寻求高特权级软件的帮助，否则就是一种异常行为了。因此，在软件执行过程中，我们经常可以看到特权级切换：\n其他的异常则一般是在执行某一条指令的时候发生了某种错误，例如除零、无效地址访问、无效指令等；或处理器认为处于当前特权级下执行等当前指令是高特权级指令或会访问不应该访问的高特权级的资源（可能危害系统）。碰到这种情况，就需要将控制权转交给高特权级的软件来处理：\n当错误/异常恢复后，则重新回到低优先级软件去执行 如不能恢复错误/异常，那高特权级软件可以杀死和清除低特权级软件，避免破坏整个执行环境 RISC-V的特权指令 与特权级无关的一般的指令和通用寄存器x0~x31在任何特权级都可以执行。而每个特权级都对应一些特殊指令和控制状态寄存器(Control and Status Register, CSR)，来控制该特权级的某些行为并描述其状态。当然特权指令不仅具有读写CSR的指令，还有其他功能的特权指令。\n如果处于低特权级状态的处理器执行了高特权级的指令，会产生非法指令错误的异常。这样，位于高特权级的执行环境能够得知低特权级的软件出现了错误，这个错误一般是不可恢复的，此时执行环境将低特权级的软件终止，这在某种程度上体现了特权级保护机制的作用。\n在RISC-V中，会有两类属于高特权级S模式的特权指令：\n指令本身属于高特权级的指令，例如sret，表示从S模式返回到U模式 指令访问了S模式特权级下才能访问的寄存器或内存，例如表示S模式系统状态的控制状态寄存器sstatus等 RISC-V S模式特权指令：\n指令 含义 sret 从S模式返回U模式：在U模式下执行会产生非法指令异常 wfi 处理器在空闲时进入低功耗状态等待中断：在U模式下执行会产生非法指令异常 sfence.vma 刷新TLB缓存：在U模式下执行会产生非法指令异常 访问S模式CSR的指令 通过访问sepc/stvec/scause/sscartch/stval/sstatus/satp等CSR来改变系统状态：在U模式下执行会产生非法指令异常 实现应用程序 接下来将设计实现被批处理系统逐个加载并运行的应用程序。应用程序的设计实现要点是：\n应用程序的内存布局 应用程序发出的系统调用 从某种程度上讲，这里设计的应用程序与第一章中的最小用户态执行环境有很多相同的地方。即设计一个应用程序和基本的支持的功能库，这样应用程序在用户态通过操作系统提供的服务完成自身的任务。\n应用程序设计 应用程序、用户库（由入口函数、初始化函数、I/O函数和系统调用接口等多个rust文件组成）放在根目录的user目录下，它和上一篇的裸机应用不同之处主要在项目的目录文件结构和内存布局上：\nuser/src/bin/*.rs：应用程序 user/src/*.rs：用户库 user/src/linker.ld：应用程序的内存布局说明 项目结构 user/src/bin目录下有多个文件，每个文件是一个应用程序，分别是：\n00hello_wordl：在屏幕上打印一行Hello, world! 01store_fault：访问一个非法的物理地址，测试批处理系统是否会被该错误影响 02power：不断在计算操作和打印字符串操作之间进行特权级切换 03priv_inst：尝试在用户态执行内核态的特权级指令sret 04priv_csr：尝试在用户态修改内核态CSR sstatus 1 2 3 4 5 6 7 8 9 10 11 12 // user/src/bin/00hello_world.rs #![no_std] #![no_main] #[macro_use] extern crate user_lib; #[no_mangle] fn main() -\u003e i32 { println!(\"Hello, world!\"); 0 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // user/src/bin/01store_fault.rs #![no_std] #![no_main] #[macro_use] extern crate user_lib; #[no_mangle] fn main() -\u003e i32 { println!(\"Into Test store_fault, we will insert an invalid store operation...\"); println!(\"Kernel should kill this application!\"); unsafe { core::ptr::null_mut::\u003cu8\u003e().write_volatile(0); } 0 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // user/src/bin/02power.rs #![no_std] #![no_main] #[macro_use] extern crate user_lib; const SIZE: usize = 10; const P: u32 = 3; const STEP: usize = 100000; const MOD: u32 = 10007; #[no_mangle] fn main() -\u003e i32 { let mut pow = [0u32; SIZE]; let mut index: usize = 0; pow[index] = 1; for i in 1..=STEP { let last = pow[index]; index = (index + 1) % SIZE; pow[index] = last * P % MOD; if i % 10000 == 0 { println!(\"{}^{}={}(MOD {})\", P, i, pow[index], MOD); } } println!(\"Test power OK!\"); 0 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // user/src/bin/03priv_inst.rs #![no_std] #![no_main] #[macro_use] extern crate user_lib; use core::arch::asm; #[no_mangle] fn main() -\u003e i32 { println!(\"Try to execute privileged instruction in U Mode\"); println!(\"Kernel should kill this application!\"); unsafe { asm!(\"sret\"); } 0 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // user/src/bin/04priv_csr.rs #![no_std] #![no_main] #[macro_use] extern crate user_lib; use riscv::register::sstatus::{self, SPP}; #[no_mangle] fn main() -\u003e i32 { println!(\"Try to access privileged CSR in U Mode\"); println!(\"Kernel should kill this application!\"); unsafe { sstatus::set_spp(SPP::User); } 0 } 批处理系统会按照文件名开头的数字编号从小到大的顺序加载并运行它们。\n每个应用程序的实现都在对应的单个文件中。打开其中一个文件，会看到只有一个main函数和若干相关函数所形成的整个应用程序逻辑。\n在user/src/lib.rs中定义了用户库的入口点_start：\n1 2 3 4 5 6 7 8 // user/src/lib.rs #[no_mangle] #[link_section = \".text.entry\"] pub extern \"C\" fn _start() -\u003e ! { clear_bss(); exit(main()); panic!(\"unreachable after sys_exit!\"); } 第3行使用Rust宏，将_start这段代码编译后的汇编代码放在一个名为.text.entry的代码段中，方便我们在后续链接的时候调整它的位置使得它能够作为用户库的入口。\n从第4行开始，进入用户库入口之后，与上一篇一样，手动清空需要零初始化的.bss段；然后调用main函数得到一个类型为i32的返回值，最后调用用户库提供的exit接口退出应用程序，并将main函数的返回值告知批处理系统。\n在lib.rs中可以看到另一个main：\n1 2 3 4 5 6 // user/src/lib.rs #[linkage = \"weak\"] #[no_mangle] fn main() -\u003e i32 { panic!(\"Cannot find main!\"); } 第2行，我们使用Rust的宏将其函数main标志为弱链接。这样最后链接的时候，虽然在lib.rs和应用程序的文件中都会有main符号，但由于lib.rs中的main符号是弱链接，链接器会使用应用程序的main。这里主要是进行某种程度上的保护，如果应用程序的文件中找不到任何main，那么编译也能够通过，但在运行时会报错。\n为了支持上述的链接操作，需要引入:\n1 2 // user/src/lib.rs #![feature(linkage)] 内存布局 在user/.cargo/config中，我们和第一章一样设置链接时使用链接脚本user/src/linker.ld。\n在linker.ld中，我们做的重要的事情是：\n将程序起始物理地址调整为0x80400000，上述五个应用程序都会被加载到这个物理地址上运行 将_start所在的.text.entry放在整个程序的开头，也就是说批处理系统只要在加载之后跳转到0x80400000就已经进入了用户库的入口点，并会在初始化之后跳转到应用程序主逻辑 提供了最终生成可执行文件的.bss段的起始和终止地址，方便clear_bss函数调用 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // user/src/linker.ld OUTPUT_ARCH(riscv) ENTRY(_start) BASE_ADDRESS = 0x80400000; SECTIONS { . = BASE_ADDRESS; .text : { *(.text.entry) *(.text .text.*) } .rodata : { *(.rodata .rodata.*) *(.srodata .srodata.*) } .data : { *(.data .data.*) *(.sdata .sdata.*) } .bss : { start_bss = .; *(.bss .bss.*) *(.sbss .sbss.*) end_bss = .; } /DISCARD/ : { *(.eh_frame) *(.debug*) } } 系统调用 在子模块syscall中，应用通过ecall调用批处理系统提供的接口，由于应用程序运行在用户态，ecall指令会触发执行环境调用异常，并Trap进入S模式执行批处理系统针对这个异常特别提供的服务代码。由于这个接口处于S模式的批处理系统和U模式的应用程序之间，这个接口可以被称为ABI或者系统调用。\n在本篇中，应用程序和批处理系统之间按照API的结构，约定如下两个系统调用：\n1 2 3 4 5 6 7 8 9 10 11 12 13 // 功能：将内存中缓冲区中的数据写入文件 // 参数： fd表示待写入文件的文件描述符 //\tbuf表示内存中缓冲区的起始地址 //\tlen表示内存中缓冲区的长度 // 返回值：返回成功写入的长度 // syscall ID：64 pub fn sys_write(fd: usize, buffer: \u0026[u8]) -\u003e isize; // 功能：退出应用程序并返回值告知批处理系统 // 参数： xstate表示应用程序的返回值 // 返回值：该系统调用无需返回 // syscall ID：93 pub fn sys_exit(exit_code: i32) -\u003e isize; 系统调用实际上是汇编指令级的二进制接口，在实际调用的时候，我们需要按照RISC-V调用规范(即ABI格式)在合适的寄存器中放置系统调用的参数，然后执行ecall指令出发Trap。在Trap回到U模式的应用程序代码之后，会从ecall的下一条指令继续执行，同时我们能够按照调用规范在合适的寄存器中读取返回值。\nRISC-V寄存器编号从0~31，表示为x0~x31。其中\nx10~x17：对应a0~a7 x1：对应ra 在RISC-V调用规范中，和函数调用的ABI情形类似，约定寄存器a0~a6保存系统调用的参数，a0保存系统调用的返回值。有些许不同的是寄存器a7用来传递syscall ID，这是因为所有的syscall都是通过ecall指令触发的，除了各输入参数之外我们还额外需要一个寄存器来保存要请求那个系统调用。由于这超出了Rust语言的表达能力，我们需要在代码中使用内嵌汇编来完成参数/返回值绑定和ecall指令的插入：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // user/src/syscall.rs use core::arch::asm; fn syscall(id: usize, args: [usize; 3]) -\u003e isize { let mut ret: isize; unsafe { asm!( \"ecall\", inlateout(\"x10\") args[0] =\u003e ret, in(\"x11\") args[1], in(\"x12\") args[2], in(\"x17\") id ); } ret } 我们将所有的系统调用都封装成了syscall函数，可以看到它支持传入syscall ID和3个参数。在 syscall中，从第6行开始的asm!宏嵌入ecall指令来触发系统调用。\n从RISC-V调用规范来看，就像函数有着输入参数和返回值一样，ecall指令同样有着输入和输出寄存器：a0~a2和a7作为输入寄存器分别表示系统调用参数和系统调用ID，而当系统调用返回后，a0作为输出寄存器保存系统调用的返回值。在函数上下文中，输入参数数组args和变量id保存系统输调用参数和系统调用ID，而变量ret保存系统调用返回值，它也是函数syscall的输出/返回值。\n那么如何将变量绑定到寄存器则成了一个难题：比如，在ecall指令被执行之前，我们需要将寄存器a7的值设置为变量id的值，那么我们首先需要知道目前变量id的值保存在哪里，它可能在栈上也有可能在某个寄存器中。作为程序员我们并不知道这些只有编译器才知道的信息，因此我们只能在编译器的帮助下完成变量到寄存器的绑定。\n现在来看asm!宏的格式：首先在第8行是我们要插入的汇编代码段本身，这里我们只插入一行ecall指令，不过它可以支持同时插入多条指令。从第9行开始我们在编译器的帮助下将输入/输出变量绑定到寄存器。例如第10行的in(\"x11\") args[1]表示将输入参数args[1]绑定到ecall的输入寄存器x11即a1中，编译器自动插入相关指令并保证在ecall指令被执行之前寄存器a1的值与args[1]的值相同。输入参数arg[2]与id到输入寄存器的绑定也是同样的方式，但是这里比较特殊的是a0寄存器，它同时作为输入和输出，因此我们将in改成inlateout，并在行末到变量部分使用{in_var} =\u003e {out_var}的格式，其中{in_var}和{out_var}分别表示上下文中的输入变量和输出变量。\n有些时候不必将变量绑定到固定的寄存器，此时asm!宏可以自动完成寄存器分配。某些汇编代码段还会带来一些编译器无法预知的副作用，这种情况下需要asm!中通过options告知寄存器这些可能的副作用，这样可以帮助编译器在避免出错的情况下更高效的分配寄存器。\n对于sys_write和sys_exit只需将syscall进行封装：\n1 2 3 4 5 6 7 8 9 10 11 // user/src/syscall.rs const SYSCALL_WRITE: usize = 64; const SYSCALL_EXIT: usize = 93; pub fn sys_write(fd: usize, buffer: \u0026[u8]) -\u003e isize { syscall(SYSCALL_WRITE, [fd, buffer.as_ptr() as usize, buffer.len()]) } pub fn sys_exit(exit_code: i32) -\u003e isize { syscall(SYSCALL_EXIT, [exit_code as usize, 0, 0]) } 注意sys_write使用一个\u0026[u8]切片类型来描述缓冲区，这是一个胖指针(Fat Pointer)，里面既包含缓冲区的起始地址，还包含缓冲区的长度。\n我们将上述两个系统调用在用户库user_lib中进一步封装，从而更加接近在Linux等平台下的实际系统调用接口：\n1 2 3 4 5 6 7 8 9 // user/src/lib.rs use syscall::*; pub fn write(fd: usize, buf: \u0026[u8]) -\u003e isize { sys_write(fd, buf) } pub fn exit(exit_code: i32) -\u003e isize { sys_exit(exit_code) } 我们将console子模块中的Stdout::write_str改成基于write的实现，且传入的fd参数设置为1，它代表标准输出，也就是输出到屏幕。目前不需要考虑其他的fd选取情况。这样，应用程序的println!宏借助系统调用变得可以用了。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // user/src/console.rs use super::write; use core::fmt::{self, Write}; struct Stdout; const STDOUT: usize = 1; impl Write for Stdout { fn write_str(\u0026mut self, s: \u0026str) -\u003e fmt::Result { write(STDOUT, s.as_bytes()); Ok(()) } } pub fn print(args: fmt::Arguments) { Stdout.write_fmt(args).unwrap(); } #[macro_export] macro_rules! print { ($fmt: literal $(, $($arg: tt)+)?) =\u003e { $crate::console::print(format_args!($fmt $(, $($arg)+)?)); } } #[macro_export] macro_rules! println { ($fmt: literal $(, $($arg: tt)+)?) =\u003e { $crate::console::print(format_args!(concat!($fmt, \"\\n\") $(, $($arg)+)?)); } } exit接口则在用户库中的_start内使用，当应用程序主逻辑main返回之后，使用它退出应用并将返回值告知底层的批处理系统。\n编译生成应用程序二进制码 简单介绍一下user/Makefile：\n对于src/bin下的每个应用程序，在target/riscv64gc-unknown-none-elf/release目录下生成一个同名的ELF可执行文件 使用objcopy二进制工具，将上一步生成的ELF文件删除所有ELF header和符号得到.bin后缀的纯二进制镜像文件。它们将被链接进内核并由内核在合适的时机加载到内存 实现批处理操作系统 在批处理操作系统中，每当一个应用执行完毕，我们需要将下一个要执行的应用的代码和数据加载到内存。\n将应用程序链接到内核 我们需要将应用程序的二进制镜像文件作为内核的数据段链接到内核里面，因此内核需要知道包含的应用程序的数量和他们的位置，这样才能够在运行时对他们进行管理并能够加载到物理内存：\n1 2 // os/src/main.rs global_asm!(include_str!(\"link_app.S\")); 这里我们引入了一段汇编代码link_app.S，它一开始并不存在，而是在构建操作系统时自动生成的。这里我们需要增加一个构建脚本，在项目根目录添加一个build.rs文件：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // os/build.rs use std::fs::{read_dir, File}; use std::io::{Result, Write}; fn main() { println!(\"cargo:rerun-if-changed=../user/src/\"); println!(\"cargo:rerun-if-changed={}\", TARGET_PATH); insert_app_data().unwrap(); } static TARGET_PATH: \u0026str = \"../user/target/riscv64gc-unknown-none-elf/release/\"; fn insert_app_data() -\u003e Result\u003c()\u003e { let mut f = File::create(\"src/link_app.S\").unwrap(); let mut apps: Vec\u003c_\u003e = read_dir(\"../user/src/bin\") .unwrap() .into_iter() .map(|dir_entry| { let mut name_with_ext = dir_entry.unwrap().file_name().into_string().unwrap(); name_with_ext.drain(name_with_ext.find('.').unwrap()..name_with_ext.len()); name_with_ext }) .collect(); apps.sort(); writeln!( f, r#\" .align 3 .section .data .global _num_app _num_app: .quad {}\"#, apps.len() )?; for i in 0..apps.len() { writeln!(f, r#\" .quad app_{}_start\"#, i)?; } writeln!(f, r#\" .quad app_{}_end\"#, apps.len() - 1)?; for (idx, app) in apps.iter().enumerate() { println!(\"app_{}: {}\", idx, app); writeln!( f, r#\" .section .data .global app_{0}_start .global app_{0}_end app_{0}_start: .incbin \"{2}{1}.bin\" app_{0}_end:\"#, idx, app, TARGET_PATH )?; } Ok(()) } Cargo会先编译和执行该构建脚本，然后再去构建整个项目。使用make build构建内核时，上述的汇编代码link_app.S就生成了：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // os/src/link_app.S .align 3 .section .data .global _num_app _num_app: .quad 5 .quad app_0_start .quad app_1_start .quad app_2_start .quad app_3_start .quad app_4_start .quad app_4_end .section .data .global app_0_start .global app_0_end app_0_start: .incbin \"../user/target/riscv64gc-unknown-none-elf/release/00hello_world.bin\" app_0_end: .section .data .global app_1_start .global app_1_end app_1_start: .incbin \"../user/target/riscv64gc-unknown-none-elf/release/01store_fault.bin\" app_1_end: .section .data .global app_2_start .global app_2_end app_2_start: .incbin \"../user/target/riscv64gc-unknown-none-elf/release/02power.bin\" app_2_end: .section .data .global app_3_start .global app_3_end app_3_start: .incbin \"../user/target/riscv64gc-unknown-none-elf/release/03priv_inst.bin\" app_3_end: .section .data .global app_4_start .global app_4_end app_4_start: .incbin \"../user/target/riscv64gc-unknown-none-elf/release/04priv_csr.bin\" a 找到并加载应用程序二进制码 我们在os的batch子模块中实现一个应用管理器，它的主要功能是：\n保存应用数量和各自的位置信息，以及当前执行到第几个应用 根据应用程序位置信息，初始化好应用所需内存空间，并加载应用执行 应用管理器AppManager结构体定义如下：\n1 2 3 4 5 6 7 8 9 // os/src/batch.rs const MAX_APP_NUM: usize = 16; struct AppManeger { num_app: usize, current_app: usize, app_start: [usize; MAX_APP_NUM + 1], } 在这里，应用管理器需要保存和维护的信息都在AppManager里面。这样设计的原因在于：我们希望将AppManager实例化为一个全局变量，使得任何函数都可以访问。然后AppManager中的current_app字段表示当前执行的第几个应用，它是一个可修改的变量，会在系统运行期间发生变。因此在声明全局变量时，采用static mut是一种比较自然的方法，但是在Rust中，任何对于static mut变量的访问控制都是unsafe的，而我们要在编程中尽量避免使用unsafe，这样才能让编译器负责更多的安全性检查。\n因此我们需要考虑如何在尽量避免触及unsafe的情况下仍能声明并使用可变的全局变量。如果单独使用static而去掉mut的话，我们可以声明一个初始化之后就不可变的全局变量，但是我们需要AppManager里面的内容在运行时发生变化。这就涉及到了Rust中\n的内部可变性(Interior Mutability)，即在变量自身不可变或仅在不可变借用的情况下仍能修改绑定到变量上的值。\n我们可以使用RefCell包裹AppManager，这样RefCell无需被声明为mut，同时被包裹的AppManager也可变。但是RefCell并未被标记为Sync，因此Rust编译器认为它不能被安全的在线程间共享，也就不能作为全局变量使用。所以我们需要在RefCell的基础上，再封装一个UPSafeCell，它名字的含义是：允许我们在单核上安全使用可变全局变量。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // os/src/sync/up.rs use core::cell::{RefCell, RefMut}; pub struct UPSafeCell\u003cT\u003e { inner: RefCell\u003cT\u003e, } unsafe impl\u003cT\u003e Sync for UPSafeCell\u003cT\u003e {} impl\u003cT\u003e UPSafeCell\u003cT\u003e { pub unsafe fn new(value: T) -\u003e Self { Self { inner: RefCell::new(value), } } pub fn exclusive_access(\u0026self) -\u003e RefMut\u003c'_, T\u003e { self.inner.borrow_mut() } } 1 2 3 4 5 // os/src/sync/mod.rs mod up; pub use up::UPSafeCell; UPSafeCel对于RefCell简单进行封装，它和RefCell一样提供内部可变性和运行时借用检查，只是更加严格：调用exclusive_access可以得到它包裹的数据的独占访问权。因此当我们要访问数据时，需要首先调用exclusive_access获得数据的可变借用标记，通过它可以完成数据的读写，在操作完成之后我们需要销毁这个标记，此后才能开始对该数据的下一次访问。相比RefCell它不再允许多个读操作同时存在。\nup.rs的这段代码出现了两个unsafe：\n首先new被声明为一个unsafe函数，是因为我们希望使用者在创建一个UPSafeCell时保证在访问UPSafeell内包裹的数据时始终不违背上述模式：即访问之前调用exclusive_access，访问之后销毁借用标记再进行下一次访问。 另外，将UPSafeCell标记为Sync使得它可以作为一个全局变量。这是unsafe行为，因为编译器无法确定我们的UPSafeCell能否安全的再多线程共享。 接下来，初始化AppManager的全局实例APP_MANAGER：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // os/src/batch.rs lazy_static! { static ref APP_MANAGER: UPSafeCell\u003cAppManager\u003e = unsafe { UPSafeCell::new({ extern \"C\" { fn _num_app(); } let num_app_ptr = _num_app as usize as *const usize; let num_app = num_app_ptr.read_volatile(); let mut app_start: [usize; MAX_APP_NUM + 1] = [0; MAX_APP_NUM + 1]; let app_start_raw: \u0026[usize] = core::slice::from_raw_parts(num_app_ptr.add(1), num_app + 1); app_start[..=num_app].copy_from_slice(app_start_raw); AppManager { num_app, current_app: 0, app_start, } }) }; } 初始化的逻辑很简单，就是找到link_app.S中提供的符号_num_app，并从这里解析出应用数量以及各个应用的起始地址。\n这里使用了外部库lazy_static提供的lazy_static!宏。引入这个外部库，需要加入依赖：\n1 2 3 4 // os/Cargo.toml [dependencies] lazy_static = { version = \"1.4.0\", features = [\"spin_no_std\"] } lazy_static!宏提供了全局变量的运行时初始化功能。一般情况下，全局变量必须在编译时设置一个初始值，但是有些全局变量依赖与运行期间才能得到的数据作为初始值。这导致这些全局变量需要在运行时发生变化，即需要重新设置初始值之后才能使用。如果我们手动实现，需要把这种全局变量声明为static mut并衍生出很多unsafe代码。这里借助lazy_static!声明一个AppManager结构的名为APP_NAMAGER的全局实例，且只有在它第一次被使用到的时候，才会进行实际的初始化工作。\n为了满足我们的需求，我们要实现一些AppManager的方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 // os/src/batch.rs const APP_BASE_ADDRESS: usize = 0x80400000; const APP_SIZE_LIMIT: usize = 0x20000; impl AppManager { pub fn print_app_info(\u0026self) { println!(\"[kernel] num_app = {}\", self.num_app); for i in 0..self.num_app { println!( \"[kernel] app_{} [{:#x}, {:#x})\", i, self.app_start[i], self.app_start[i + 1] ); } } pub fn get_current_app(\u0026self) -\u003e usize { self.current_app } pub fn move_to_next_app(\u0026mut self) { self.current_app += 1; } unsafe fn load_app(\u0026self, app_id: usize) { if app_id \u003e= self.num_app { panic!(\"All applications completed!\") } println!(\"[kernel] Loading app_{}\", app_id); // clear icache asm!(\"fence.i\"); //clear app area core::slice::from_raw_parts_mut(APP_BASE_ADDRESS as *mut u8, APP_SIZE_LIMIT).fill(0); let app_src = core::slice::from_raw_parts( self.app_start[app_id] as *const u8, self.app_start[app_id + 1] - self.app_start[app_id], ); let app_dst = core::slice::from_raw_parts_mut(APP_BASE_ADDRESS as *mut u8, app_src.len()); app_dst.copy_from_slice(app_src); } } load_app方法，负责将参数app_id对应的应用程序的二进制镜像加载到物理内存以0x80400000起始的位置，这个位置是批处理操作系统和应用程序之间约定的常数地址，在之前我们也调整应用程序的内存布局以同一个地址开头。第36行开始，我们首先将一块内存清空，然后找到待加载应用二进制镜像的位置，并将它复制到正确的位置。它的本质就是将数据从一块内存复制到另一块内存，而从批处理操作系统的角度来看，是将操作系统数据段的一部分数据复制到了一个可以执行代码的内存区域。体现了冯诺伊曼计算机的代码即数据的特征。\n第34行插入了一条汇编指令fence.i，它是用来清除i-cache的。我们知道缓存是存储级结构中提高访存速度很重要的一环。而CPU对物理内存所做的缓存有分为数据缓存(d-cache)和指令缓存(i-cache)两部分，分别在CPU访存和取指时使用。在取指时，对于一个指令地址，CPU会先去i-cache里面查看它是否在某个已缓存的缓存行内，如果在的话它就会直接从高速缓存中拿到指令而不是通过总线访问内存。通常情况下，CPU 会认为程序的代码段不会发生变化，因此 i-cache 是一种只读缓存。但在这里，OS将修改会被 CPU 取指的内存区域，这会使得 i-cache 中含有与内存中不一致的内容。因此OS在这里必须使用fence.i指令手动清空i-cache，让里面所有的内容全部失效，才能够保证CPU访问内存数据和代码的正确性。\n实现特权级的切换 由于处理器具有硬件级的特权级机制，应用程序在用户态特权级运行时，是无法直接通过函数调用访问处于内核态特权级的批处理操作系统内核中的函数。但应用程序又需要得到操作系统提供的服务，所以应用程序和操作系统需要通过某种合作机制完成特权级之间的切换，使得用户态应用程序可以得到内核态操作系统函数的服务。接下来将在RISC-V64处理器提供的U/S特权级下，解决批处理操作系统和应用程序的相互配合，完成特权级切换。\nRISC-V特权级切换 特权级切换的起因 批处理操作系统被设计为运行在内核态特权级，这是作为SEE的RustSBI保证的。而应用程序被设计为运行在用户态特权级，被操作系统为核心的执行环境监督起来。在本篇中，应用程序的执行环境则是批处理系统提供的AEE(Application Execution Environment)。批处理操作系统为了建立好应用程序的执行环境，需要在执行应用之前进行一些初始化工作，并监控应用程序的执行，具体体现在：\n当应用程序被启动时，需要初始化应用程序的用户态上下文，并能切换到用户态执行应用程序 当应用程序发起系统调用之后，需要到批处理操作系统中进行处理 当应用程序执行出错时，需要到批处理系统中杀死该应用并加载运行下一个应用 当应用程序执行结束时，需要到批处理操作系统中加载运行下一个应用 这些处理都涉及到特权级切换，因此需要应用程序、操作系统和硬件一起协同，完成特权级切换机制。\n特权级切换相关的控制状态寄存器 当从一般意义上讨论RISC-V架构的Trap机制时，通常需要注意两点：\n在触发Trap之前CPU运行在哪个特权级 CPU需要切换到哪个特权级来处理该Trap，并在处理完成之后返回原特权级 在本篇中，我们仅考虑如下流程：当CPU在用户态特权级运行应用程序，执行到Trap，切换到内核态特权级，批处理操作系统的对应代码相应Trap，并执行系统调用服务，处理完毕后，从内核态返回到用户态应用程序继续执行后续指令。\n在RISC-V架构中，关于Trap有一条重要规则：在Trap前的特权级不会高于Trap后的特权级。因此如果触发Trap之后切换到S特权级，说明Trap发生之前CPU只能运行在S/U特权级。但无论如何，只要Trap到S特权级，操作系统就会使用S特权级中与Trap相关的控制状态寄存器(CSR)来辅助Trap处理。进入S特权级Trap的相关CSR：\nCSR名 该CSR与Trap相关的功能 sstatus spp等字段给出Trap发生之前CPU处在哪个特权级等信息 sepc 当Trap是一个异常时，记录Trap发生之前执行的最后一条指令的地址 scause 描述Trap的原因 stval 给出Trap附加信息 stvec 控制Trap处理代码的入口地址 特权级切换 当执行一条Trap类指令，如ecall时，CPU发现触发了一个异常并需要进行特殊处理，这涉及到执行环境切换。应用程序被切换回来之后需要从发出系统调用请求的执行位置恢复应用程序上下文并继续执行，这需要在切换前后维持应用程序的上下文保持不变。应用程序的上下文包括通用寄存器和栈两个主要部分。由于CPU在不同特权级下共享一套通用寄存器，所以在运行操作系统的Trap操作过程中，操作系统也会用到这些寄存器，这会改变应用程序的上下文。因此，与函数调用需要保存函数调用上下文/活动记录一样，在执行操作系统的Trap处理过程之前，我们需要在某个地方保存这些寄存器并在Trap处理结束后恢复这些寄存器。\n除了通用寄存器之外还有一些可能在处理Trap过程中会被修改的CSR，比如CPU所在的特权级。我们要保证它们的变化在我们的预期之内。比如，对特权级转换而言，应该是Trap之前在U特权级，处理Trap的时候在S特权级，返回之后又需要回到U特权级。而对于栈问题则相对简单，只要两个应用程序执行过程中用来记录执行历史的栈所对应的内存区域不想交，就不会产生令我们头痛的覆盖问题和数据破坏问题，也就无需进行保存/恢复。\n特权级切换的具体过程一部分由硬件直接完成，另一部分则需要由操作系统来实现。\n特权级切换的硬件控制机制 当CPU执行完一条指令(例如:ecall)并准备从用户特权级Trap到S特权级时，硬件会自动完成以下事情：\nsstatus的SPP字段会被修改为CPU当前特权级 spec会被修改为Trap处理完成后默认会执行的下一条指令的地址 scause/stval分别会被修改成这次Trap的原因以及相关附加信息 CPU会跳转到stvec所设置的Trap处理入口地址，并将当前特权级设置为S，然后从Trap处理入口地址开始执行 而当CPU完成Trap处理准备返回的时候，需要通过一条S特权级的特权指令sret来完成，这一条指令具体完成以下功能：\nCPU会将当前的特权级按照sstatus的SPP字段设置为U或者S CPU会跳转到spec寄存器指向那条指令，然后继续执行 用户栈与内存栈 在Trap触发的一瞬间，CPU就会切换到S特权级并跳转到stvec\t所指示的位置。但是在正式进入S特权级的Trap之前，上面提到过我们必须保存原控制流的寄存器转台，这一般通过内核栈来保存。注意，我们需要用专门为操作系统准备的内核栈，而非应用程序运行时用到的用户栈。\n使用两个不同的栈主要是为了安全性：如果两个控制流使用同一个栈，在返回之后应用程序就能读到Trap控制流的历史信息，比如内核一些函数的地址，这样会带来安全隐患。于是，我们要做的事，在批处理操作系统中添加一段汇编代码，实现从用户栈切换到内核栈，并在内核栈上保存应用程序控制流的寄存器状态。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // os/src/batch.rs const KERNEL_STACK_SIZE: usize = 4096 * 2; const USER_STACK_SIZE: usize = 4096 * 2; static KERNEL_STACK: KernelStack = KernelStack { data: [0; KERNEL_STACK_SIZE], }; static USER_STACK: UserStack = UserStack { data: [0; USER_STACK_SIZE], }; #[repr(align(4096))] struct KernelStack { data: [u8; KERNEL_STACK_SIZE], } #[repr(align(4096))] struct UserStack { data: [u8; USER_STACK_SIZE], } KERNEL_STACK_SIZE和USER_STACK_SIZE指出内核栈和用户栈道大小分别为$8KiB$。两个类型是以全局变量的形式实例化在批处理操作系统的.bss段中的。\n我们为两个类型实现了get_sp方法来获取栈顶地址。由于RISC-V中栈是向下增长的，我们只需返回包裹的数组的结尾地址：\n1 2 3 4 5 6 7 8 9 10 11 12 13 // os/src/batch.rs impl KernelStack { fn get_sp(\u0026self) -\u003e usize { self.data.as_ptr() as usize + KERNEL_STACK_SIZE } } impl UserStack { fn get_sp(\u0026self) -\u003e usize { self.data.as_ptr() as usize + USER_STACK_SIZE } } 于是换栈是非常简单的，只需将sp寄存器的值修改为get_sp的返回值即可。\n接下来是Trap上下文，类似前面提到的函数调用上下文，即在Trap发生时需要保存的物力资源内容，并将其放在一个名为TrapContext的类型中，定义如下：\n1 2 3 4 5 6 7 8 9 10 // os/src/trap/context.rs use riscv::register::sstatus::Sstatus; #[repr(C)] pub struct TrapContext { pub x: [usize; 32], pub sstatus: Sstatus, pub sepc: usize, } 可以看到里面包含所有的通用寄存器x0~x31，还有sstatuc和spec。为什么保存它们呢？\n对于通用寄存器而言，两条控制流运行在不同的特权级，所属的软件也可能由不同的编程语言编写，虽然在Trap控制流中只是会执行Trap处理相关的代码，但依然可以直接或间接调用很多模块，因此很难甚至不可能找出哪些寄存器无需保存，既然如此只能全部保存。但也有一些例外，x0被硬编码成0，它自然不会有变化，还有tp(x4)寄存器，除非我们手动处于一些特殊用途使用它，否则一般也不会被用到。它们虽然无需被保存，但我们仍然为其预留空间，主要是为了后续的实现方便。 对于CSR而言，我们知道进入Trap的时候，硬件会立即覆盖掉scause/stval/sstatus/sepc的全部或是其中一部分。scause/stval的情况是：它总是被Trap处理的第一时间就被使用或者在其他地方保存下来了，因此它没有被修改并造成不良影响的风险。而对于sstatus/sepc而言，它们会在Trap处理的全程有意义（在Trap控制流最后sret的时候还用到了它们），而且确实会出现Trap嵌套的情况使得它们的值被覆盖掉。所以我们需要将它们保存下来，并在sret之前恢复原样。 Trap管理 特权级切换的核心是对Trap的管理。主要涉及如下一些内容：\n应用程序通过ecall进入到内核状态时，操作系统保存被打断的应用程序的Trap上下文 操作系统根据Trap相关的CSR寄存器内容，完成系统调用服务的分发与处理 操作系统完成系统调用服务后，需要恢复被打断的应用程序的Trap上下文，并通过sret让应用程序继续执行 Trap上下文的保存与恢复 首先是具体实现Trap上下文保存和恢复的汇编代码，在批处理操作系统初始化的时候，我们需要修改stvec寄存器来指向正确的Trap处理入口点：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // os/src/trap/mod.rs use core::arch::global_asm; use riscv::register::{mtvec::TrapMode, stvec}; global_asm!(include_str!(\"trap.S\")); pub fn init() { extern \"C\" { fn __alltraps(); } unsafe { stvec::write(__alltraps as usize, TrapMode::Direct); } } 这里我们引入了一个外部符号__alltraps，并将stvec设置为Direct模式指向它的地址。我们在os/src/trap/trap.S中实现Trap上下文保存/恢复的汇编代码，分别用外部符号__alltraps和__restore标记为函数，并通过global_asm!宏将这段汇编代码插入进来。\nTrap处理的总体流程如下：首先通过__alltraps将Trap上下文保存在内核栈上，然后跳转到使用Rust编写的trap_handler函数完成Trap分发及处理。当trap_handler返回之后，使用__restore从保存在内核栈上的Trap上下文恢复寄存器。最后通过sret指令回到应用程序执行。\n首先是保存Trap上下文的__alltraps的实现：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # os/src/trap/trap.S .macro SAVE_GP n ld x\\n, \\n*8(sp) .endm .align 2 __alltraps: csrrw sp, sscratch, sp # now sp-\u003ekernel stack, sscratch-\u003euser stack # allocate a TrapContext on kernel stack addi sp, sp, -34*8 # save general-purpose registers sd x1, 1*8(sp) # skip sp(x2), we will save it later sd x3, 3*8(sp) # skip tp(x4), application does not use it # save x5~x31 .set n, 5 .rept 27 SAVE_GP %n .set n, n+1 .endr # we can use t0/t1/t2 freely, because they were saved on kernel stack csrr t0, sstatus csrr t1, sepc sd t0, 32*8(sp) sd t1, 33*8(sp) # read user stack from sscratch and save it on the kernel stack csrr t2, sscratch sd t2, 2*8(sp) # set input argument of trap_handler(cx: \u0026mut TrapContext) mv a0, sp call trap_handler 第7行我们使用.align将__alltraps的地址4字节对齐，这是RISC-V特权级规范的要求 第9行的csrrw原型是csrrw rd, csr, rs，可以将CSR当前的值读到通用寄存器rd中，然后将通用寄存器rs的值写入该CSR。因此这里起到的是交换sscratch和sp的效果。在这一行之前sp指向用户栈，sscratch指向内核栈，之后sp指向内核栈，sscratch指向用户栈 第12行，我们准备在内核栈上保存Trap上下文，于是预先分配$34 \\times 8$字节的栈帧，这里改动的是sp，说明确实是在内核栈上 第13～24行，保存Trap上下文的通用寄存器x0~x31，跳过x0和tp(x4)，原因之前已经说明。在这里也无需保存sp(x2)，因为我们要基于它来找到每个寄存器应该被保存到的正确的位置。实际上，在栈帧分配之后，我们可用于保存Trap上下文的地址区间为$[sp, sp+8 \\times 34)$，按照TrapContext结构体的内存布局，基于内核栈道位置(sp所指向的地址)来从低地址到高地址分别按顺序放置x0~x31这些通用寄存器，最后是sstatus和sepc。因此通用寄存器xn应该被保存在地址区间$[sp+8n,sp+8(n+1))$。为了简化代码，x5~x31这27个通用寄存器我们通过类似循环的.rept每次使用SAVE_GP宏来保存，其实质是相同的。注意我们需要在trap.S开头加上.altmacro才能正确使用.rept命令 第25～28行，将CSR sstatus和sepc的值分别读到寄存器t0和t1中然后保存到内核栈对应的位置上。指令csrr rd, csr功能就是将CSR的值读到寄存器rd中 第30～31行专门处理sp的问题。首先将sscratch的值读取到寄存器t2并保存到内核栈上。注意：此时sscratch指向用户栈，sp指向内核栈 第33行令a0\u003c-sp，让寄存器a0指向内核栈的栈指针也就是我们刚刚保存的Trap上下文的地址，这是由于我们接下来调用trap_handler进行Trap处理，它的第一个参数cx由调用规范要从a0中获取。而Trap处理函数trap_handler需要Trap上下文的原因在于：它需要知道其中某些寄存器的值，比如在系统调用的时候应用程序传过来的syscall ID和对应参数。 当trap_handler返回之后会从调用trap_handler的下一条指令开始执行，也就是从栈上的Trap上下文恢复的__restore：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # os/src/trap/trap.S .macro LOAD_GP n ld x\\n, \\n*8(sp) .endm __restore: # case1: start running app by __restore # case2: back to U after handling trap mv sp, a0 # now sp-\u003ekernel stack(after allocated), sscratch-\u003euser stack # restore sstatus/sepc ld t0, 32*8(sp) ld t1, 33*8(sp) ld t2, 2*8(sp) csrw sstatus, t0 csrw sepc, t1 csrw sscratch, t2 # restore general-purpuse registers except sp/tp ld x1, 1*8(sp) ld x3, 3*8(sp) .set n, 5 .rept 27 LOAD_GP %n .set n, n+1 .endr # release TrapContext on kernel stack addi sp, sp, 34*8 # now sp-\u003ekernel stack, sscratch-\u003euser stack csrrw sp, sscratch, sp sret 第13～26行负责从内核栈顶的Trap上下文恢复通用寄存器和CSR。我们要先恢复CSR再恢复通用寄存器，这样我们使用的三个临时寄存器才能被正确恢复 在第28行之前，sp指向保存了Trap上下文之后的内核栈栈顶，sscratch指向用户栈栈顶。在第28行内核栈上回收Trap上下文所占用的内存，回归进入Trap之前的内核栈栈顶。第30行，再次交换sscratch和sp，现在sp重新只想用户栈栈顶，sscratch也依然保存进入Trap之前的状态并指向内核栈栈顶 在应用程序控制流状态会还原之后，第31行使用sret指令回到U特权级继续运行应用程序控制流 Trap分发与处理 Trap在使用Rust实现的trap_handler函数中完成分发和处理：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // os/src/trap/mod.rs #[no_mangle] pub fn trap_handler(cx: \u0026mut TrapContext) -\u003e \u0026mut TrapContext { let scause = scause::read(); let stval = stval::read(); match scause.cause() { Trap::Exception(Exception::UserEnvCall) =\u003e { cx.sepc += 4; cx.x[10] = syscall(cx.x[17], [cx.x[10], cx.x[11], cx.x[12]]) as usize; } Trap::Exception(Exception::StoreFault) | Trap::Exception(Exception::StorePageFault) =\u003e { println!(\"[kernel] PageFault in application, kernel killed it.\"); run_next_app(); } Trap::Exception(Exception::IllegalInstruction) =\u003e { println!(\"[kernel] IllegalInstruction in application, kernel killed it.\"); run_next_app(); } _ =\u003e { panic!( \"Unsupported trap {:?}, stval = {:#x}\", scause.cause(), stval ); } } cx } 第4行声明返回值为\u0026mut TrapContext并在第28行将传入的Trap上下文cx原样返回，因此在__restore的时候a0寄存器在调用trap_handler前后并没有发生变化，仍然指向分配Trap上下文之后的内核栈栈顶，和此时sp的值相同，这里的sp\u003c-a0并不会有问题\n第7行根据scause寄存器所保存的Trap的原因进行分发处理。这里我们无须手动操作这些CSR，而是使用Rust的riscv库来更加方便的操作。引入riscv库，需要在os/Cargo.toml中添加：\n1 2 3 4 # os/Cargo.toml [dependencies] riscv = { git = \"https://github.com/rcore-os/riscv\", features = [\"inline-asm\"] } 第8～11行，发现触发Trap的原因是来自于U特权级的Environment Call，也就是系统调用。这里我们首先修改保存在内核栈上的Trap上下文里面sepc，让其增加4。这是因为我们知道这是一个由ecall指令触发的系统调用，在进入Trap的时候，硬件会将sepc设置为这条ecall指令所在的地址。而在Trap返回之后，我们希望应用程序控制流从ecall的下一条指令开始执行。因此我们只需修改Trap上下文里面的sepc，让他增加ecall指令的码长，即4字节。这样在__restore的时候sepc在恢复之后就会指向ecall的下一条指令，并在sret之后从这里开始执行。\n用来保存系统调用返回值的a0寄存器也会同样发生变化。我们从Trap上下文取出作为syscall ID的a7和系统调用的三个参数`\n第12～19行，分别处理应用程序出现访存错误和非法指令错误的情况。此时需要打印错误信息并调用run_next_app直接切换并运行下一个应用程序。\n第20行开始，当遇到目前还不支持的Trap类型的时候，批处理操作系统整个panic报错退出。\n实现系统调用功能 对于系统调用而言，syscall函数并不会实际处理系统调用，而只是根据syscall ID分发到具体的处理函数：\n1 2 3 4 5 6 7 8 9 10 11 12 // os/src/syscall/mod.rs const SYSCALL_WRITE: usize = 64; const SYSCALL_EXIT: usize = 93; pub fn syscall(syscall_id: usize, args: [usize; 3]) -\u003e isize { match syscall_id { SYSCALL_WRITE =\u003e sys_write(args[0], args[1] as *const u8, args[2]), SYSCALL_EXIT =\u003e sys_exit(args[0] as i32), _ =\u003e panic!(\"Unsupported syscall_id: {}\", syscall_id), } } 这里我们会将传进来的参数args转化成能够被具体的系统调用处理函数接受的类型：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // os/src/syscall/fs.rs const FD_STDOUT: usize = 1; pub fn sys_write(fd: usize, buf: *const u8, len: usize) -\u003e isize { match fd { FD_STDOUT =\u003e { let slice = unsafe { core::slice::from_raw_parts(buf, len) }; let str = core::str::from_utf8(slice).unwrap(); print!(\"{}\", str); len as isize } _ =\u003e { panic!(\"Unsupported fd in sys_write!\"); } } } 1 2 3 4 5 6 // os/src/syscall/process/rs pub fn sys_exit(exit_code: i32) -\u003e ! { println!(\"[kernel] Application exited with code {}\", exit_code); run_next_app() } sys_write我们将传入的位于应用程序内的缓冲区的开始地址和长度转化成一个字符串\u0026str，然后使用批处理操作系统已经实现的print!宏打印出来。 sys_exit打印退出的应用程序的返回值并同样调用run_next_app切换到下一个应用程序。 执行应用程序 当批处理操作系统初始化完成，或者是某个应用运行结束或出错的时候，我们要调用run_next_app函数切换到下一个应用程序。此时CPU运行在S特权级，而它希望能切换到U特权级。在RISC-V架构中，唯一一种使得CPU特权级下降的方法就是执行Trap返回到特权指令，如sret、mret等。事实上，在从操作系统内核返回到运行应用程序之前，要完成如下这些工作：\n构造应用程序开始执行所需要的Trap上下文 通过__restore函数，从刚构造的Trap上下文中，恢复应用程序执行的部分寄存器 设置sepcCSR的内容为应用程序入口点0x80400000 切换scratch和sp寄存器，设置sp指向应用程序用户栈 执行sret从S特权级切换到U特权级 它们可以通过复用__restore的代码来更容易的实现上述工作。我们只需要在内核栈上压入一个为启动应用程序而特殊构造的Trap上下文，在通过__restore函数，就能让这些寄存器到达启动应用程序所需要的上下文状态。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // os/src/trap/context.rs impl TrapContext { pub fn set_sp(\u0026mut self, sp: usize) { self.x[2] = sp; } pub fn app_init_context(entry: usize, sp: usize) -\u003e Self { let mut sstatus = sstatus::read(); sstatus.set_spp(SPP::User); let mut cx = Self { x: [0; 32], sstatus, sepc: entry, }; cx.set_sp(sp); cx } } 为TrapContext实现app_init_context方法，修改其中的sepc寄存器为应用程序入口点entry，sp寄存器为我们设定的一个栈指针，并将sstatus寄存器的SPP字段设置为User。\n在run_next_app函数中我们能够看到：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // os/src/batch.rs pub fn run_next_app() -\u003e ! { let mut app_manager = APP_MANAGER.exclusive_access(); let current_app = app_manager.get_current_app(); unsafe { app_manager.load_app(current_app); } app_manager.move_to_next_app(); drop(app_manager); extern \"C\" { fn __restore(cx_addr: usize); } unsafe { __restore(KERNEL_STACK.push_context(TrapContext::app_init_context( APP_BASE_ADDRESS, USER_STACK.get_sp(), )) as *const _ as usize); } panic!(\"Unreachable in batch::run_current_app!\"); } 在17～22行所做的事情就是在内核栈上压入一个Trap上下文，其sepc是应用程序入口0x80400000 ，其sp寄存器指向用户栈，其sstatus的SPP字段被设置为User。push_context的返回值是内核栈压入Trap上下文之后的栈顶，它会被作为__restore的参数，这使得在__restore函数中sp仍然可以指向内核栈道栈顶。这之后，就和执行一次普通的__restore函数调用一样了。\n","wordCount":"2719","inLanguage":"en","datePublished":"2022-10-10T16:33:51+08:00","dateModified":"2022-10-10T16:33:51+08:00","author":{"@type":"Person","name":"Ther"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.niuwx.cn/posts/rcore/os2/"},"publisher":{"@type":"Organization","name":"Ther's Blog -- 个人笔记","logo":{"@type":"ImageObject","url":"https://www.niuwx.cn/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.niuwx.cn/ accesskey=h title="Ther's Blog -- 个人笔记 (Alt + H)">Ther's Blog -- 个人笔记</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.niuwx.cn/ title=Home><span>Home</span></a></li><li><a href=https://www.niuwx.cn/archive title=Archives><span>Archives</span></a></li><li><a href=https://www.niuwx.cn/categories title=Categories><span>Categories</span></a></li><li><a href=https://www.niuwx.cn/tags title=Tags><span>Tags</span></a></li><li><a href=https://www.niuwx.cn/friends title=Friends><span>Friends</span></a></li><li><a href=https://www.niuwx.cn/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.niuwx.cn/>Home</a>&nbsp;»&nbsp;<a href=https://www.niuwx.cn/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://www.niuwx.cn/posts/rcore/>rCore</a></div><h1 class=post-title>rCore-os2-批处理系统</h1><div class=post-description>Desc Text.</div><div class=post-meta>October 10, 2022&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Ther&nbsp;|&nbsp;<a href=https://github.com/isther/isther.github.io/tree/master/content/posts/rCore/os2.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%89%b9%e6%9d%83%e7%ba%a7%e6%9c%ba%e5%88%b6 aria-label=特权级机制>特权级机制</a><ul><li><a href=#%e7%89%b9%e6%9d%83%e7%ba%a7%e7%9a%84%e8%bd%af%e7%a1%ac%e4%bb%b6%e5%8d%8f%e5%90%8c%e8%ae%be%e8%ae%a1 aria-label=特权级的软硬件协同设计>特权级的软硬件协同设计</a></li><li><a href=#risc-v%e7%89%b9%e6%9d%83%e7%ba%a7%e6%9e%b6%e6%9e%84 aria-label=RISC-V特权级架构>RISC-V特权级架构</a></li><li><a href=#risc-v%e7%9a%84%e7%89%b9%e6%9d%83%e6%8c%87%e4%bb%a4 aria-label=RISC-V的特权指令>RISC-V的特权指令</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f aria-label=实现应用程序>实现应用程序</a><ul><li><a href=#%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e8%ae%be%e8%ae%a1 aria-label=应用程序设计>应用程序设计</a><ul><li><a href=#%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84 aria-label=项目结构>项目结构</a></li><li><a href=#%e5%86%85%e5%ad%98%e5%b8%83%e5%b1%80 aria-label=内存布局>内存布局</a></li><li><a href=#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8 aria-label=系统调用>系统调用</a></li></ul></li><li><a href=#%e7%bc%96%e8%af%91%e7%94%9f%e6%88%90%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e4%ba%8c%e8%bf%9b%e5%88%b6%e7%a0%81 aria-label=编译生成应用程序二进制码>编译生成应用程序二进制码</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e6%89%b9%e5%a4%84%e7%90%86%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f aria-label=实现批处理操作系统>实现批处理操作系统</a><ul><li><a href=#%e5%b0%86%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e9%93%be%e6%8e%a5%e5%88%b0%e5%86%85%e6%a0%b8 aria-label=将应用程序链接到内核>将应用程序链接到内核</a></li><li><a href=#%e6%89%be%e5%88%b0%e5%b9%b6%e5%8a%a0%e8%bd%bd%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e4%ba%8c%e8%bf%9b%e5%88%b6%e7%a0%81 aria-label=找到并加载应用程序二进制码>找到并加载应用程序二进制码</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e7%89%b9%e6%9d%83%e7%ba%a7%e7%9a%84%e5%88%87%e6%8d%a2 aria-label=实现特权级的切换>实现特权级的切换</a><ul><li><a href=#risc-v%e7%89%b9%e6%9d%83%e7%ba%a7%e5%88%87%e6%8d%a2 aria-label=RISC-V特权级切换>RISC-V特权级切换</a><ul><li><a href=#%e7%89%b9%e6%9d%83%e7%ba%a7%e5%88%87%e6%8d%a2%e7%9a%84%e8%b5%b7%e5%9b%a0 aria-label=特权级切换的起因>特权级切换的起因</a></li><li><a href=#%e7%89%b9%e6%9d%83%e7%ba%a7%e5%88%87%e6%8d%a2%e7%9b%b8%e5%85%b3%e7%9a%84%e6%8e%a7%e5%88%b6%e7%8a%b6%e6%80%81%e5%af%84%e5%ad%98%e5%99%a8 aria-label=特权级切换相关的控制状态寄存器>特权级切换相关的控制状态寄存器</a></li><li><a href=#%e7%89%b9%e6%9d%83%e7%ba%a7%e5%88%87%e6%8d%a2 aria-label=特权级切换>特权级切换</a></li></ul></li><li><a href=#%e7%89%b9%e6%9d%83%e7%ba%a7%e5%88%87%e6%8d%a2%e7%9a%84%e7%a1%ac%e4%bb%b6%e6%8e%a7%e5%88%b6%e6%9c%ba%e5%88%b6 aria-label=特权级切换的硬件控制机制>特权级切换的硬件控制机制</a></li><li><a href=#%e7%94%a8%e6%88%b7%e6%a0%88%e4%b8%8e%e5%86%85%e5%ad%98%e6%a0%88 aria-label=用户栈与内存栈>用户栈与内存栈</a></li><li><a href=#trap%e7%ae%a1%e7%90%86 aria-label=Trap管理>Trap管理</a><ul><li><a href=#trap%e4%b8%8a%e4%b8%8b%e6%96%87%e7%9a%84%e4%bf%9d%e5%ad%98%e4%b8%8e%e6%81%a2%e5%a4%8d aria-label=Trap上下文的保存与恢复>Trap上下文的保存与恢复</a></li><li><a href=#trap%e5%88%86%e5%8f%91%e4%b8%8e%e5%a4%84%e7%90%86 aria-label=Trap分发与处理>Trap分发与处理</a></li></ul></li><li><a href=#%e5%ae%9e%e7%8e%b0%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%8a%9f%e8%83%bd aria-label=实现系统调用功能>实现系统调用功能</a></li><li><a href=#%e6%89%a7%e8%a1%8c%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f aria-label=执行应用程序>执行应用程序</a></li></ul></li></ul></div></details></div><div class=post-content><p>保障系统安全和多应用支持是操作系统的两个核心目标，本章从这两个目标出发，思考如何设计应用程序，并进一步展现操作系统的一系列新功能:</p><ul><li>构造包含操作系统内核和多个应用程序的单一执行程序</li><li>通过批处理支持多个程序的自动加载和运行</li><li>操作系统利用硬件特权级机制，实现对操作系统自身的保护</li><li>实现特权级的跨越</li><li>支持跨特权级的系统调用功能</li></ul><p><code>批处理系统(Batch System)</code>，它可以用来管理无需或仅需少量用户交互即可运行的程序，在资源允许的情况下它可以自动安排程序的执行，这被称为批处理作业，此名词源自二十世纪60年代的大型机时代。批处理系统的核心思想是：将多个程序打包到一起输入计算机，当一个程序运行结束后，计算机自动加载下一个程序到内存并执行。</p><p>本片代码:</p><ul><li><a href=https://github.com/isther/rCore/tree/os2>代码地址</a></li></ul><h2 id=特权级机制>特权级机制<a hidden class=anchor aria-hidden=true href=#特权级机制>#</a></h2><p>为了保护我们的批处理系统不受到出错应用程序的影响并全程稳定工作，单凭软件实现是很难做到的，而是需要CPU提供一种特权级隔离机制，使CPU在执行应用程序和操作系统内核的指令时处于不同的特权级。</p><h3 id=特权级的软硬件协同设计>特权级的软硬件协同设计<a hidden class=anchor aria-hidden=true href=#特权级的软硬件协同设计>#</a></h3><p>实现特权级机制的根本原因是应用程序运行的安全性不可充分信任。由于操作系统和应用程序两者通过编译器形成一个单一执行程序来执行，导致即使是应用本身的问题，也会牵连操作系统，导致整个计算机系统出现问题。</p><p>所以，计算机科学家和工程师想出了一个办法：让相对安全可靠的操作系统运行在一个硬件保护的安全执行环境中，不受应用程序的破坏；而让应用程序运行在另外一个无法破坏操作系统的受限执行环境中。</p><p>为了确保操作系统的安全，对应用程序而言，需要限制的主要有两个方面：</p><ul><li>应用程序不能访问任意的地址空间</li><li>应用程序不能执行某些可能破坏计算机系统的指令</li></ul><p>除此之外，还需要确保应用程序能够得到操作系统的服务，即应用程序和操作系统还需要有交互的手段。使得低特权级机制只能做高特权级软件允许它做的，且超出低特权级能力的功能必须寻求高特权级软件的帮助。</p><p>为了实现这样的特权级机制，需要进行软硬件协同设计。一个比较简洁的方法就是，处理器设置两个不同安全等级的执行环境：</p><ul><li>用户态特权级的执行环境</li><li>内核态特权级的执行环境</li></ul><p>且明确指出可能破坏计算机系统的内核态特权级指令子集，内核态特权级指令子集只能在内核态特权级的执行环境中执行。处理器在执行指令前会进行特权级安全检查，如果在用户态执行环境中执行内核态特权级指令，会产生异常。</p><p>为了让应用程序获得操作系统的函数服务，采用传统的函数调用方(即通常的<code>call</code>和<code>ret</code>指令或指令组合)将会绕过硬件的特权级保护检查。所以可以设计新的机器指令：执行环境调用(Execution Environment Call 简称 <code>ecall</code>)和执行环境返回(Excution Environment Return 简称 <code>eret</code>)</p><ul><li><code>ecall</code>：具有用户态到内核态到执行环境切换能力的函数调用指令</li><li><code>eret</code>：具有内核态到用户态的执行环境切换能力的函数返回指令</li></ul><p>硬件具有了这样的机制后，还需要操作系统的配合才能最终完成对操作系统自身的保护。</p><ul><li>首先，操作系统需要提供相应的功能代码，能在执行<code>eret</code>前准备和恢复用户态执行应用程序的上下文。</li><li>其次，在应用程序调用<code>ecall</code>指令后，能够检查应用程序的系统调用参数，确保参数不会破坏操作系统。</li></ul><h3 id=risc-v特权级架构>RISC-V特权级架构<a hidden class=anchor aria-hidden=true href=#risc-v特权级架构>#</a></h3><p>RISC-V架构一共定义了4种特权级：</p><table><thead><tr><th style=text-align:center>级别</th><th style=text-align:center>编码</th><th style=text-align:center>名称</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>00</td><td style=text-align:center>用户/应用模式(U, User/Application)</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>01</td><td style=text-align:center>监督模式(S, Supervistor)</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>10</td><td style=text-align:center>虚拟监督模式(H, Hypervistor)</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>11</td><td style=text-align:center>机器模式(M, Machine)</td></tr></tbody></table><p>级别数值越大，特权级越高，掌控硬件的能力越强。</p><p>在CPU硬件层面，除了M模式必须存在外，其他模式可以不存在。RISC-V架构中，只有M模式是必须实现的，剩下的特权级则可以根据跑在CPU上应用的实际需求进行调整：</p><ul><li>简单的嵌入式应用只需要实现M模式</li><li>带有一定保护能力的嵌入式系统需要实现M/U模式</li><li>复杂的多任务系统则需要实现M/S/U模式</li><li>到目前为止，H模式特权规范还没有完全制定好</li></ul><p>从特权级架构的角度看待执行环境栈：</p><p><img loading=lazy src=/rCore/PrivilegeStack.png alt=PrivilegeStack></p><p>其中，白色块表示一层执行环境，黑色块表示相邻两层执行环境之间的接口。其中操作系统内核代码运行在S模式上；应用程序运行在U模式上。</p><p>运行在M模式上的软件被称为<strong>监督模式执行环境</strong>(SEE, Supervistor Execution Environment)，比如在操作系统运行前负责加载操作系统的Bootloader-RustSBI。站在运行在S模式上的软件视角来看，它的下面也需要一层执行环境支撑，因此被命名为SEE，它需要在相比S模式更高的特权级下运行，一般情况下SEE在M模式上执行。</p><p>执行环境的功能之一是在它支持的上层软件执行之前进行一些初始化工作。之前提到的引导加载程序会在加电之后对整个系统进行初始化，它实际上就是SEE功能的一部分。也就是说在RISC-V架构上的引导加载程序一般运行在M模式上。</p><p>在上一节中，实现了简单的操作系统，它和应用程序全程运行在S模式下，应用程序很容易破坏没有任何保护的执行环境-操作系统。在之后，我们会涉及RISC-V的M/S/U三种特权级：</p><ul><li>应用程序和用户态支持库运行在U模式的最低特权级</li><li>操作系统内核运行在S模式特权级，形成支撑应用程序和用户态支持的执行环境</li><li>在之前提到的bootloader-RurstSBI实际上是运行在更底层的M模式特权级下的软件，是操作系统内核的执行环境。</li></ul><p>执行环境的另一种功能是对上层软件的执行进行监控管理。可以理解为，当上层软件执行出现了一些异常或者特殊情况时，导致需要用到执行环境中提供的功能，因此需要暂停上层软件的执行，转而运行执行环境的代码。</p><p>由于上层软件和执行环境被设计为运行在不同的特权级，这个过程也往往**（不一定）<strong>伴随着CPU的</strong>特权级切换**。当执行环境的代码运行结束后，我们需要回到上层软件暂停的位置继续执行。在RISC-V架构中，这种与常规控制流不同的<strong>异常控制流(ECF, Exception Control Flow)<strong>被称为</strong>异常(Exception)</strong>，在RISC-V语境下的Trap种类之一。</p><p>用户态应用直接触发从用户态到内核态的异常的原因总体上可以分为两种：</p><ul><li>用户态软件为获得内核态操作系统的服务功能而执行特殊指令</li><li>在执行某条指令期间发生了错误并被CPU检测到，例如执行了用户态不允许执行的指令或者其他错误</li></ul><p>下表是RISC-V特权级规范定义的可能会导致从低特权级到高特权级到各种<strong>异常</strong>：</p><table><thead><tr><th style=text-align:center>Interrupt</th><th style=text-align:center>Exception Code</th><th style=text-align:center>Description</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>Instruction address misaligned</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>Instruction access fault</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>2</td><td style=text-align:center>Illegal instruction</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>3</td><td style=text-align:center>Breakpoint</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>4</td><td style=text-align:center>Load address misaligned</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>5</td><td style=text-align:center>Load access fault</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>6</td><td style=text-align:center>Stroe/AMO address misaligned</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>7</td><td style=text-align:center>Store/AMO access fault</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>8</td><td style=text-align:center>Environment call from U-mode</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>9</td><td style=text-align:center>Environment call from S-mode</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>11</td><td style=text-align:center>Environment call from M-mode</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>12</td><td style=text-align:center>Instruction page fault</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>13</td><td style=text-align:center>Load page fault</td></tr><tr><td style=text-align:center>0</td><td style=text-align:center>15</td><td style=text-align:center>Stroe/AMO page fault</td></tr></tbody></table><p>其中，<code>断点(Breakpoint)</code>和<code>执行环境调用(Enviroment call)</code>两种异常（这种有意而为之的指令称为<em>陷入</em>或<em>trap</em>类指令）是通常在上层软件中执行一条特定的指令触发的：执行<code>ebreak</code>这条指令之后就会触发断点陷入异常；而执行<code>ecall</code>这条指令之后则会随着CPU当前所处特权级而触发不同的异常。</p><p>执行环境调用<code>ecall</code>，这是一种很特殊的<em>陷入</em>类的指令，在之前从特权级架构看待执行环境栈这张图中，相邻两特权级软件之间的接口正是基于这种陷入机制实现的。M模式软件SEE和S模式的内核之间的接口被称为<strong>监督模式二进制接口(Supervistor Binary Interface, SBI)</strong>，而内核和U模式的应用程序之间的接口被称为<strong>应用程序二进制接口(Application Binary Interface, ABI)</strong>，它还有一个更加通俗的名字：<strong>系统调用(syscall ,System Cal)</strong>。而之所以叫做二进制接口，是因为它与高级编程语言的内部调用接口不同，是机器/汇编指令级的一种接口。</p><p>事实上M/S/U三个特权级的软件可分别由不同的编程语言实现。即使是用同一种汇编语言实现，其调用也不是普通的函数调用，而是<strong>陷入异常控制流</strong>，在该过程中切换CPU特权级。因此只有将接口下降到机器/汇编指令级才能满足其跨高级语言的通用性和灵活性。</p><p>可以看到，在这样的架构之下，每层特权级的软件都只能做高特权级软件允许它做的，并且不会产生什么撼动高特权级软件的情况，一旦低特权级软件的要求超出了其能力范围，就必须寻求高特权级软件的帮助，否则就是一种异常行为了。因此，在软件执行过程中，我们经常可以看到特权级切换：</p><p><img loading=lazy src=/rCore/EnvironmentCallFlow.png alt=EnvironmentCallFlow></p><p>其他的异常则一般是在执行某一条指令的时候发生了某种错误，例如除零、无效地址访问、无效指令等；或处理器认为处于当前特权级下执行等当前指令是高特权级指令或会访问不应该访问的高特权级的资源（可能危害系统）。碰到这种情况，就需要将控制权转交给高特权级的软件来处理：</p><ul><li>当错误/异常恢复后，则重新回到低优先级软件去执行</li><li>如不能恢复错误/异常，那高特权级软件可以杀死和清除低特权级软件，避免破坏整个执行环境</li></ul><h3 id=risc-v的特权指令>RISC-V的特权指令<a hidden class=anchor aria-hidden=true href=#risc-v的特权指令>#</a></h3><p>与特权级无关的一般的指令和通用寄存器<code>x0</code>~<code>x31</code>在任何特权级都可以执行。而每个特权级都对应一些特殊指令和<code>控制状态寄存器(Control and Status Register, CSR)</code>，来控制该特权级的某些行为并描述其状态。当然特权指令不仅具有读写CSR的指令，还有其他功能的特权指令。</p><p>如果处于低特权级状态的处理器执行了高特权级的指令，会产生非法指令错误的异常。这样，位于高特权级的执行环境能够得知低特权级的软件出现了错误，这个错误一般是不可恢复的，此时执行环境将低特权级的软件终止，这在某种程度上体现了特权级保护机制的作用。</p><p>在RISC-V中，会有两类属于高特权级S模式的特权指令：</p><ul><li>指令本身属于高特权级的指令，例如<code>sret</code>，表示从S模式返回到U模式</li><li>指令访问了S模式特权级下才能访问的寄存器或内存，例如表示S模式系统状态的<strong>控制状态寄存器</strong><code>sstatus</code>等</li></ul><p>RISC-V S模式特权指令：</p><table><thead><tr><th style=text-align:center>指令</th><th style=text-align:center>含义</th></tr></thead><tbody><tr><td style=text-align:center>sret</td><td style=text-align:center>从S模式返回U模式：在U模式下执行会产生非法指令异常</td></tr><tr><td style=text-align:center>wfi</td><td style=text-align:center>处理器在空闲时进入低功耗状态等待中断：在U模式下执行会产生非法指令异常</td></tr><tr><td style=text-align:center>sfence.vma</td><td style=text-align:center>刷新TLB缓存：在U模式下执行会产生非法指令异常</td></tr><tr><td style=text-align:center>访问S模式CSR的指令</td><td style=text-align:center>通过访问sepc/stvec/scause/sscartch/stval/sstatus/satp等CSR来改变系统状态：在U模式下执行会产生非法指令异常</td></tr></tbody></table><h2 id=实现应用程序>实现应用程序<a hidden class=anchor aria-hidden=true href=#实现应用程序>#</a></h2><p>接下来将设计实现被批处理系统逐个加载并运行的应用程序。应用程序的设计实现要点是：</p><ul><li>应用程序的内存布局</li><li>应用程序发出的系统调用</li></ul><p>从某种程度上讲，这里设计的应用程序与第一章中的最小用户态执行环境有很多相同的地方。即设计一个应用程序和基本的支持的功能库，这样应用程序在用户态通过操作系统提供的服务完成自身的任务。</p><h3 id=应用程序设计>应用程序设计<a hidden class=anchor aria-hidden=true href=#应用程序设计>#</a></h3><p>应用程序、用户库（由入口函数、初始化函数、I/O函数和系统调用接口等多个rust文件组成）放在根目录的<code>user</code>目录下，它和上一篇的裸机应用不同之处主要在项目的目录文件结构和内存布局上：</p><ul><li><code>user/src/bin/*.rs</code>：应用程序</li><li><code>user/src/*.rs</code>：用户库</li><li><code>user/src/linker.ld</code>：应用程序的内存布局说明</li></ul><h4 id=项目结构>项目结构<a hidden class=anchor aria-hidden=true href=#项目结构>#</a></h4><p><code>user/src/bin</code>目录下有多个文件，每个文件是一个应用程序，分别是：</p><ul><li><code>00hello_wordl</code>：在屏幕上打印一行<code>Hello, world!</code></li><li><code>01store_fault</code>：访问一个非法的物理地址，测试批处理系统是否会被该错误影响</li><li><code>02power</code>：不断在计算操作和打印字符串操作之间进行特权级切换</li><li><code>03priv_inst</code>：尝试在用户态执行内核态的特权级指令<code>sret</code></li><li><code>04priv_csr</code>：尝试在用户态修改内核态CSR <code>sstatus</code></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/bin/00hello_world.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#![no_std]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![no_main]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_use]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> user_lib;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#66d9ef>i32</span> {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Hello, world!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/bin/01store_fault.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#![no_std]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![no_main]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_use]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> user_lib;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#66d9ef>i32</span> {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Into Test store_fault, we will insert an invalid store operation...&#34;</span>);
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Kernel should kill this application!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        core::ptr::null_mut::<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span>().write_volatile(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/bin/02power.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#![no_std]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![no_main]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_use]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> user_lib;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> SIZE: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> P: <span style=color:#66d9ef>u32</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> STEP: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>100000</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> MOD: <span style=color:#66d9ef>u32</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10007</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#66d9ef>i32</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> pow <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span><span style=color:#66d9ef>u32</span>; SIZE];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> index: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    pow[index] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>..=</span>STEP {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> last <span style=color:#f92672>=</span> pow[index];
</span></span><span style=display:flex><span>        index <span style=color:#f92672>=</span> (index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> SIZE;
</span></span><span style=display:flex><span>        pow[index] <span style=color:#f92672>=</span> last <span style=color:#f92672>*</span> P <span style=color:#f92672>%</span> MOD;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>10000</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            println!(<span style=color:#e6db74>&#34;{}^{}={}(MOD {})&#34;</span>, P, i, pow[index], MOD);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Test power OK!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/bin/03priv_inst.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#![no_std]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![no_main]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_use]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> user_lib;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> core::arch::asm;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#66d9ef>i32</span> {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Try to execute privileged instruction in U Mode&#34;</span>);
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Kernel should kill this application!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        asm!(<span style=color:#e6db74>&#34;sret&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/bin/04priv_csr.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#![no_std]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#![no_main]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_use]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>crate</span> user_lib;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> riscv::register::sstatus::{self, SPP};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#66d9ef>i32</span> {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Try to access privileged CSR in U Mode&#34;</span>);
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;Kernel should kill this application!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        sstatus::set_spp(SPP::User);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>批处理系统会按照文件名开头的数字编号从小到大的顺序加载并运行它们。</p><p>每个应用程序的实现都在对应的单个文件中。打开其中一个文件，会看到只有一个<code>main</code>函数和若干相关函数所形成的整个应用程序逻辑。</p><p>在<code>user/src/lib.rs</code>中定义了用户库的入口点<code>_start</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[link_section = </span><span style=color:#e6db74>&#34;.text.entry&#34;</span><span style=color:#75715e>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>_start</span>() -&gt; <span style=color:#f92672>!</span> {
</span></span><span style=display:flex><span>    clear_bss();
</span></span><span style=display:flex><span>    exit(main());
</span></span><span style=display:flex><span>    panic!(<span style=color:#e6db74>&#34;unreachable after sys_exit!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>第3行使用Rust宏，将<code>_start</code>这段代码编译后的汇编代码放在一个名为<code>.text.entry</code>的代码段中，方便我们在后续链接的时候调整它的位置使得它能够作为用户库的入口。</p><p>从第4行开始，进入用户库入口之后，与上一篇一样，手动清空需要零初始化的<code>.bss</code>段；然后调用<code>main</code>函数得到一个类型为<code>i32</code>的返回值，最后调用用户库提供的<code>exit</code>接口退出应用程序，并将<code>main</code>函数的返回值告知批处理系统。</p><p>在<code>lib.rs</code>中可以看到另一个<code>main</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#[linkage = </span><span style=color:#e6db74>&#34;weak&#34;</span><span style=color:#75715e>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; <span style=color:#66d9ef>i32</span> {
</span></span><span style=display:flex><span>    panic!(<span style=color:#e6db74>&#34;Cannot find main!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>第2行，我们使用Rust的宏将其函数<code>main</code>标志为弱链接。这样最后链接的时候，虽然在<code>lib.rs</code>和应用程序的文件中都会有<code>main</code>符号，但由于<code>lib.rs</code>中的<code>main</code>符号是弱链接，链接器会使用应用程序的<code>main</code>。这里主要是进行某种程度上的保护，如果应用程序的文件中找不到任何<code>main</code>，那么编译也能够通过，但在运行时会报错。</p><p>为了支持上述的链接操作，需要引入:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#![feature(linkage)]</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=内存布局>内存布局<a hidden class=anchor aria-hidden=true href=#内存布局>#</a></h4><p>在<code>user/.cargo/config</code>中，我们和第一章一样设置链接时使用链接脚本<code>user/src/linker.ld</code>。</p><p>在<code>linker.ld</code>中，我们做的重要的事情是：</p><ul><li>将程序起始物理地址调整为<code>0x80400000</code>，上述五个应用程序都会被加载到这个物理地址上运行</li><li>将<code>_start</code>所在的<code>.text.entry</code>放在整个程序的开头，也就是说批处理系统只要在加载之后跳转到<code>0x80400000</code>就已经进入了用户库的入口点，并会在初始化之后跳转到应用程序主逻辑</li><li>提供了最终生成可执行文件的<code>.bss</code>段的起始和终止地址，方便<code>clear_bss</code>函数调用</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/linker.ld
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>OUTPUT_ARCH(riscv)
</span></span><span style=display:flex><span>ENTRY(_start)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BASE_ADDRESS <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x80400000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SECTIONS
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    . <span style=color:#f92672>=</span> BASE_ADDRESS;
</span></span><span style=display:flex><span>    .text : {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.text.entry)
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.text .text.<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    .rodata : {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.rodata .rodata.<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.srodata .srodata.<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    .data : {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.data .data.<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.sdata .sdata.<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    .bss : {
</span></span><span style=display:flex><span>        start_bss <span style=color:#f92672>=</span> .;
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.bss .bss.<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.sbss .sbss.<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>        end_bss <span style=color:#f92672>=</span> .;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#f92672>/</span>DISCARD<span style=color:#f92672>/</span> : {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.eh_frame)
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(.debug<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=系统调用>系统调用<a hidden class=anchor aria-hidden=true href=#系统调用>#</a></h4><p>在子模块<code>syscall</code>中，应用通过<code>ecall</code>调用批处理系统提供的接口，由于应用程序运行在用户态，<code>ecall</code>指令会触发执行环境调用异常，并Trap进入S模式执行批处理系统针对这个异常特别提供的服务代码。由于这个接口处于S模式的批处理系统和U模式的应用程序之间，这个接口可以被称为ABI或者系统调用。</p><p>在本篇中，应用程序和批处理系统之间按照API的结构，约定如下两个系统调用：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// 功能：将内存中缓冲区中的数据写入文件
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 参数： fd表示待写入文件的文件描述符
</span></span></span><span style=display:flex><span><span style=color:#75715e>//		 buf表示内存中缓冲区的起始地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>//		 len表示内存中缓冲区的长度
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 返回值：返回成功写入的长度
</span></span></span><span style=display:flex><span><span style=color:#75715e>// syscall ID：64
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sys_write</span>(fd: <span style=color:#66d9ef>usize</span>, buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; <span style=color:#66d9ef>isize</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 功能：退出应用程序并返回值告知批处理系统
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 参数： xstate表示应用程序的返回值
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 返回值：该系统调用无需返回
</span></span></span><span style=display:flex><span><span style=color:#75715e>// syscall ID：93
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sys_exit</span>(exit_code: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>isize</span>;
</span></span></code></pre></td></tr></table></div></div><p>系统调用实际上是汇编指令级的二进制接口，在实际调用的时候，我们需要按照RISC-V调用规范(即ABI格式)在合适的寄存器中放置系统调用的参数，然后执行<code>ecall</code>指令出发Trap。在Trap回到U模式的应用程序代码之后，会从<code>ecall</code>的下一条指令继续执行，同时我们能够按照调用规范在合适的寄存器中读取返回值。</p><p>RISC-V寄存器编号从<code>0~31</code>，表示为<code>x0~x31</code>。其中</p><ul><li><code>x10~x17</code>：对应<code>a0~a7</code></li><li><code>x1</code>：对应<code>ra</code></li></ul><p>在RISC-V调用规范中，和函数调用的ABI情形类似，约定寄存器<code>a0~a6</code>保存系统调用的参数，<code>a0</code>保存系统调用的返回值。有些许不同的是寄存器<code>a7</code>用来传递<code>syscall ID</code>，这是因为所有的syscall都是通过<code>ecall</code>指令触发的，除了各输入参数之外我们还额外需要一个寄存器来保存要请求那个系统调用。由于这超出了Rust语言的表达能力，我们需要在代码中使用内嵌汇编来完成参数/返回值绑定和<code>ecall</code>指令的插入：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/syscall.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> core::arch::asm;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>syscall</span>(id: <span style=color:#66d9ef>usize</span>, args: [<span style=color:#66d9ef>usize</span>; <span style=color:#ae81ff>3</span>]) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> ret: <span style=color:#66d9ef>isize</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        asm!(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ecall&#34;</span>,
</span></span><span style=display:flex><span>            inlateout(<span style=color:#e6db74>&#34;x10&#34;</span>) args[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=&gt;</span> ret,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>in</span>(<span style=color:#e6db74>&#34;x11&#34;</span>) args[<span style=color:#ae81ff>1</span>],
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>in</span>(<span style=color:#e6db74>&#34;x12&#34;</span>) args[<span style=color:#ae81ff>2</span>],
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>in</span>(<span style=color:#e6db74>&#34;x17&#34;</span>) id
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ret
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>我们将所有的系统调用都封装成了<code>syscall</code>函数，可以看到它支持传入syscall ID和3个参数。在 <code>syscall</code>中，从第6行开始的<code>asm!</code>宏嵌入<code>ecall</code>指令来触发系统调用。</p><p>从RISC-V调用规范来看，就像函数有着输入参数和返回值一样，<code>ecall</code>指令同样有着输入和输出寄存器：<code>a0~a2</code>和<code>a7</code>作为输入寄存器分别表示系统调用参数和系统调用ID，而当系统调用返回后，<code>a0</code>作为输出寄存器保存系统调用的返回值。在函数上下文中，输入参数数组<code>args</code>和变量<code>id</code>保存系统输调用参数和系统调用ID，而变量<code>ret</code>保存系统调用返回值，它也是函数<code>syscall</code>的输出/返回值。</p><p>那么如何将变量绑定到寄存器则成了一个难题：比如，在<code>ecall</code>指令被执行之前，我们需要将寄存器<code>a7</code>的值设置为变量<code>id</code>的值，那么我们首先需要知道目前变量<code>id</code>的值保存在哪里，它可能在栈上也有可能在某个寄存器中。作为程序员我们并不知道这些只有编译器才知道的信息，因此我们只能在编译器的帮助下完成变量到寄存器的绑定。</p><p>现在来看<code>asm!</code>宏的格式：首先在第8行是我们要插入的汇编代码段本身，这里我们只插入一行<code>ecall</code>指令，不过它可以支持同时插入多条指令。从第9行开始我们在编译器的帮助下将输入/输出变量绑定到寄存器。例如第10行的<code>in("x11") args[1]</code>表示将输入参数<code>args[1]</code>绑定到<code>ecall</code>的输入寄存器<code>x11</code>即<code>a1</code>中，编译器自动插入相关指令并保证在<code>ecall</code>指令被执行之前寄存器<code>a1</code>的值与<code>args[1]</code>的值相同。输入参数<code>arg[2]</code>与<code>id</code>到输入寄存器的绑定也是同样的方式，但是这里比较特殊的是<code>a0</code>寄存器，它同时作为输入和输出，因此我们将<code>in</code>改成<code>inlateout</code>，并在行末到变量部分使用<code>{in_var} => {out_var}</code>的格式，其中<code>{in_var}</code>和<code>{out_var}</code>分别表示上下文中的输入变量和输出变量。</p><p>有些时候不必将变量绑定到固定的寄存器，此时<code>asm!</code>宏可以自动完成寄存器分配。某些汇编代码段还会带来一些编译器无法预知的副作用，这种情况下需要<code>asm!</code>中通过<code>options</code>告知寄存器这些可能的副作用，这样可以帮助编译器在避免出错的情况下更高效的分配寄存器。</p><p>对于<code>sys_write</code>和<code>sys_exit</code>只需将<code>syscall</code>进行封装：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/syscall.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> SYSCALL_WRITE: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>64</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> SYSCALL_EXIT: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>93</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sys_write</span>(fd: <span style=color:#66d9ef>usize</span>, buffer: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span>    syscall(SYSCALL_WRITE, [fd, buffer.as_ptr() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>, buffer.len()])
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sys_exit</span>(exit_code: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span>    syscall(SYSCALL_EXIT, [exit_code <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>注意<code>sys_write</code>使用一个<code>&[u8]</code>切片类型来描述缓冲区，这是一个<strong>胖指针</strong>(Fat Pointer)，里面既包含缓冲区的起始地址，还包含缓冲区的长度。</p><p>我们将上述两个系统调用在用户库<code>user_lib</code>中进一步封装，从而更加接近在Linux等平台下的实际系统调用接口：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/lib.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> syscall::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>write</span>(fd: <span style=color:#66d9ef>usize</span>, buf: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span>    sys_write(fd, buf)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>exit</span>(exit_code: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span>    sys_exit(exit_code)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>我们将<code>console</code>子模块中的<code>Stdout::write_str</code>改成基于<code>write</code>的实现，且传入的<code>fd</code>参数设置为1，它代表标准输出，也就是输出到屏幕。目前不需要考虑其他的<code>fd</code>选取情况。这样，应用程序的<code>println!</code>宏借助系统调用变得可以用了。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// user/src/console.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> <span style=color:#66d9ef>super</span>::write;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> core::fmt::{self, Write};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Stdout</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> STDOUT: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Write <span style=color:#66d9ef>for</span> Stdout {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>write_str</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, s: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; <span style=color:#a6e22e>fmt</span>::Result {
</span></span><span style=display:flex><span>        write(STDOUT, s.as_bytes());
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print</span>(args: <span style=color:#a6e22e>fmt</span>::Arguments) {
</span></span><span style=display:flex><span>    Stdout.write_fmt(args).unwrap();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_export]</span>
</span></span><span style=display:flex><span>macro_rules! print {
</span></span><span style=display:flex><span>    (<span style=color:#75715e>$fmt</span>: <span style=color:#a6e22e>literal</span> <span style=color:#75715e>$(,</span> <span style=color:#75715e>$($arg</span>: <span style=color:#a6e22e>tt</span>)<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>$crate</span>::console::print(format_args!(<span style=color:#75715e>$fmt</span> <span style=color:#75715e>$(,</span> <span style=color:#75715e>$($arg</span>)<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[macro_export]</span>
</span></span><span style=display:flex><span>macro_rules! println {
</span></span><span style=display:flex><span>    (<span style=color:#75715e>$fmt</span>: <span style=color:#a6e22e>literal</span> <span style=color:#75715e>$(,</span> <span style=color:#75715e>$($arg</span>: <span style=color:#a6e22e>tt</span>)<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>$crate</span>::console::print(format_args!(concat!(<span style=color:#75715e>$fmt</span>, <span style=color:#e6db74>&#34;\n&#34;</span>) <span style=color:#75715e>$(,</span> <span style=color:#75715e>$($arg</span>)<span style=color:#f92672>+</span>)<span style=color:#f92672>?</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>exit</code>接口则在用户库中的<code>_start</code>内使用，当应用程序主逻辑<code>main</code>返回之后，使用它退出应用并将返回值告知底层的批处理系统。</p><h3 id=编译生成应用程序二进制码>编译生成应用程序二进制码<a hidden class=anchor aria-hidden=true href=#编译生成应用程序二进制码>#</a></h3><p>简单介绍一下<code>user/Makefile</code>：</p><ul><li>对于<code>src/bin</code>下的每个应用程序，在<code>target/riscv64gc-unknown-none-elf/release</code>目录下生成一个同名的ELF可执行文件</li><li>使用objcopy二进制工具，将上一步生成的ELF文件删除所有ELF header和符号得到<code>.bin</code>后缀的纯二进制镜像文件。它们将被链接进内核并由内核在合适的时机加载到内存</li></ul><h2 id=实现批处理操作系统>实现批处理操作系统<a hidden class=anchor aria-hidden=true href=#实现批处理操作系统>#</a></h2><p>在批处理操作系统中，每当一个应用执行完毕，我们需要将下一个要执行的应用的代码和数据加载到内存。</p><h3 id=将应用程序链接到内核>将应用程序链接到内核<a hidden class=anchor aria-hidden=true href=#将应用程序链接到内核>#</a></h3><p>我们需要将应用程序的二进制镜像文件作为内核的数据段链接到内核里面，因此内核需要知道包含的应用程序的数量和他们的位置，这样才能够在运行时对他们进行管理并能够加载到物理内存：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/main.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>global_asm!(include_str!(<span style=color:#e6db74>&#34;link_app.S&#34;</span>));
</span></span></code></pre></td></tr></table></div></div><p>这里我们引入了一段汇编代码<code>link_app.S</code>，它一开始并不存在，而是在构建操作系统时自动生成的。这里我们需要增加一个构建脚本，在项目根目录添加一个<code>build.rs</code>文件：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/build.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> std::fs::{read_dir, File};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::io::{Result, Write};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;cargo:rerun-if-changed=../user/src/&#34;</span>);
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;cargo:rerun-if-changed={}&#34;</span>, TARGET_PATH);
</span></span><span style=display:flex><span>    insert_app_data().unwrap();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> TARGET_PATH: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../user/target/riscv64gc-unknown-none-elf/release/&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>insert_app_data</span>() -&gt; Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> f <span style=color:#f92672>=</span> File::create(<span style=color:#e6db74>&#34;src/link_app.S&#34;</span>).unwrap();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> apps: Vec<span style=color:#f92672>&lt;</span>_<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> read_dir(<span style=color:#e6db74>&#34;../user/src/bin&#34;</span>)
</span></span><span style=display:flex><span>        .unwrap()
</span></span><span style=display:flex><span>        .into_iter()
</span></span><span style=display:flex><span>        .map(<span style=color:#f92672>|</span>dir_entry<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> name_with_ext <span style=color:#f92672>=</span> dir_entry.unwrap().file_name().into_string().unwrap();
</span></span><span style=display:flex><span>            name_with_ext.drain(name_with_ext.find(<span style=color:#e6db74>&#39;.&#39;</span>).unwrap()<span style=color:#f92672>..</span>name_with_ext.len());
</span></span><span style=display:flex><span>            name_with_ext
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        .collect();
</span></span><span style=display:flex><span>    apps.sort();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    writeln!(
</span></span><span style=display:flex><span>        f,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>r#&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .align 3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .section .data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .global _num_app
</span></span></span><span style=display:flex><span><span style=color:#e6db74>_num_app:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .quad {}&#34;#</span>,
</span></span><span style=display:flex><span>        apps.len()
</span></span><span style=display:flex><span>    )<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>apps.len() {
</span></span><span style=display:flex><span>        writeln!(f, <span style=color:#e6db74>r#&#34;    .quad app_{}_start&#34;#</span>, i)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    writeln!(f, <span style=color:#e6db74>r#&#34;    .quad app_{}_end&#34;#</span>, apps.len() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (idx, app) <span style=color:#66d9ef>in</span> apps.iter().enumerate() {
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;app_{}: {}&#34;</span>, idx, app);
</span></span><span style=display:flex><span>        writeln!(
</span></span><span style=display:flex><span>            f,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>r#&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .section .data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .global app_{0}_start
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .global app_{0}_end
</span></span></span><span style=display:flex><span><span style=color:#e6db74>app_{0}_start:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    .incbin &#34;{2}{1}.bin&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>app_{0}_end:&#34;#</span>,
</span></span><span style=display:flex><span>            idx, app, TARGET_PATH
</span></span><span style=display:flex><span>        )<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Cargo会先编译和执行该构建脚本，然后再去构建整个项目。使用<code>make build</code>构建内核时，上述的汇编代码<code>link_app.S</code>就生成了：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// os/src/link_app.S
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    .align 3
</span></span><span style=display:flex><span>    .section .data
</span></span><span style=display:flex><span>    .global _num_app
</span></span><span style=display:flex><span>_num_app:
</span></span><span style=display:flex><span>    .quad 5
</span></span><span style=display:flex><span>    .quad app_0_start
</span></span><span style=display:flex><span>    .quad app_1_start
</span></span><span style=display:flex><span>    .quad app_2_start
</span></span><span style=display:flex><span>    .quad app_3_start
</span></span><span style=display:flex><span>    .quad app_4_start
</span></span><span style=display:flex><span>    .quad app_4_end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    .section .data
</span></span><span style=display:flex><span>    .global app_0_start
</span></span><span style=display:flex><span>    .global app_0_end
</span></span><span style=display:flex><span>app_0_start:
</span></span><span style=display:flex><span>    .incbin &#34;../user/target/riscv64gc-unknown-none-elf/release/00hello_world.bin&#34;
</span></span><span style=display:flex><span>app_0_end:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    .section .data
</span></span><span style=display:flex><span>    .global app_1_start
</span></span><span style=display:flex><span>    .global app_1_end
</span></span><span style=display:flex><span>app_1_start:
</span></span><span style=display:flex><span>    .incbin &#34;../user/target/riscv64gc-unknown-none-elf/release/01store_fault.bin&#34;
</span></span><span style=display:flex><span>app_1_end:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    .section .data
</span></span><span style=display:flex><span>    .global app_2_start
</span></span><span style=display:flex><span>    .global app_2_end
</span></span><span style=display:flex><span>app_2_start:
</span></span><span style=display:flex><span>    .incbin &#34;../user/target/riscv64gc-unknown-none-elf/release/02power.bin&#34;
</span></span><span style=display:flex><span>app_2_end:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    .section .data
</span></span><span style=display:flex><span>    .global app_3_start
</span></span><span style=display:flex><span>    .global app_3_end
</span></span><span style=display:flex><span>app_3_start:
</span></span><span style=display:flex><span>    .incbin &#34;../user/target/riscv64gc-unknown-none-elf/release/03priv_inst.bin&#34;
</span></span><span style=display:flex><span>app_3_end:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    .section .data
</span></span><span style=display:flex><span>    .global app_4_start
</span></span><span style=display:flex><span>    .global app_4_end
</span></span><span style=display:flex><span>app_4_start:
</span></span><span style=display:flex><span>    .incbin &#34;../user/target/riscv64gc-unknown-none-elf/release/04priv_csr.bin&#34;
</span></span><span style=display:flex><span>a
</span></span></code></pre></td></tr></table></div></div><h3 id=找到并加载应用程序二进制码>找到并加载应用程序二进制码<a hidden class=anchor aria-hidden=true href=#找到并加载应用程序二进制码>#</a></h3><p>我们在<code>os</code>的<code>batch</code>子模块中实现一个应用管理器，它的主要功能是：</p><ul><li>保存应用数量和各自的位置信息，以及当前执行到第几个应用</li><li>根据应用程序位置信息，初始化好应用所需内存空间，并加载应用执行</li></ul><p>应用管理器<code>AppManager</code>结构体定义如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/batch.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> MAX_APP_NUM: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>AppManeger</span> {
</span></span><span style=display:flex><span>    num_app: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    current_app: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>    app_start: [<span style=color:#66d9ef>usize</span>; MAX_APP_NUM <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>],
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在这里，应用管理器需要保存和维护的信息都在<code>AppManager</code>里面。这样设计的原因在于：我们希望将<code>AppManager</code>实例化为一个全局变量，使得任何函数都可以访问。然后<code>AppManager</code>中的<code>current_app</code>字段表示当前执行的第几个应用，它是一个可修改的变量，会在系统运行期间发生变。因此在声明全局变量时，采用<code>static mut</code>是一种比较自然的方法，但是在Rust中，任何对于<code>static mut</code>变量的访问控制都是unsafe的，而我们要在编程中尽量避免使用unsafe，这样才能让编译器负责更多的安全性检查。</p><p>因此我们需要考虑如何在尽量避免触及unsafe的情况下仍能声明并使用可变的全局变量。如果单独使用<code>static</code>而去掉<code>mut</code>的话，我们可以声明一个初始化之后就不可变的全局变量，但是我们需要<code>AppManager</code>里面的内容在运行时发生变化。这就涉及到了Rust中</p><p>的<strong>内部可变性</strong>(Interior Mutability)，即在变量自身不可变或仅在不可变借用的情况下仍能修改绑定到变量上的值。</p><p>我们可以使用<code>RefCell</code>包裹<code>AppManager</code>，这样<code>RefCell</code>无需被声明为<code>mut</code>，同时被包裹的<code>AppManager</code>也可变。但是<code>RefCell</code>并未被标记为<code>Sync</code>，因此Rust编译器认为它不能被安全的在线程间共享，也就不能作为全局变量使用。所以我们需要在<code>RefCell</code>的基础上，再封装一个<code>UPSafeCell</code>，它名字的含义是：允许我们在单核上安全使用可变全局变量。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/sync/up.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> core::cell::{RefCell, RefMut};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>UPSafeCell</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    inner: <span style=color:#a6e22e>RefCell</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Sync <span style=color:#66d9ef>for</span> UPSafeCell<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> UPSafeCell<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>(value: <span style=color:#a6e22e>T</span>) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        Self {
</span></span><span style=display:flex><span>            inner: <span style=color:#a6e22e>RefCell</span>::new(value),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>exclusive_access</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>RefMut</span><span style=color:#f92672>&lt;&#39;</span>_, T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        self.inner.borrow_mut()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/sync/mod.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>mod</span> up;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>use</span> up::UPSafeCell;
</span></span></code></pre></td></tr></table></div></div><p><code>UPSafeCel</code>对于<code>RefCell</code>简单进行封装，它和<code>RefCell</code>一样提供内部可变性和运行时借用检查，只是更加严格：调用<code>exclusive_access</code>可以得到它包裹的数据的独占访问权。因此当我们要访问数据时，需要首先调用<code>exclusive_access</code>获得数据的可变借用标记，通过它可以完成数据的读写，在操作完成之后我们需要销毁这个标记，此后才能开始对该数据的下一次访问。相比<code>RefCell</code>它不再允许多个读操作同时存在。</p><p><code>up.rs</code>的这段代码出现了两个<code>unsafe</code>：</p><ul><li>首先<code>new</code>被声明为一个<code>unsafe</code>函数，是因为我们希望使用者在创建一个<code>UPSafeCell</code>时保证在访问<code>UPSafeell</code>内包裹的数据时始终不违背上述模式：即访问之前调用<code>exclusive_access</code>，访问之后销毁借用标记再进行下一次访问。</li><li>另外，将<code>UPSafeCell</code>标记为<code>Sync</code>使得它可以作为一个全局变量。这是unsafe行为，因为编译器无法确定我们的<code>UPSafeCell</code>能否安全的再多线程共享。</li></ul><p>接下来，初始化<code>AppManager</code>的全局实例<code>APP_MANAGER</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/batch.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>lazy_static<span style=color:#f92672>!</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>ref</span> APP_MANAGER: <span style=color:#a6e22e>UPSafeCell</span><span style=color:#f92672>&lt;</span>AppManager<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        UPSafeCell::new({
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>_num_app</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> num_app_ptr <span style=color:#f92672>=</span> _num_app <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span> <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>usize</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> num_app <span style=color:#f92672>=</span> num_app_ptr.read_volatile();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> app_start: [<span style=color:#66d9ef>usize</span>; MAX_APP_NUM <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> [<span style=color:#ae81ff>0</span>; MAX_APP_NUM <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> app_start_raw: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>usize</span>] <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                core::slice::from_raw_parts(num_app_ptr.add(<span style=color:#ae81ff>1</span>), num_app <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            app_start[<span style=color:#f92672>..=</span>num_app].copy_from_slice(app_start_raw);
</span></span><span style=display:flex><span>            AppManager {
</span></span><span style=display:flex><span>                num_app,
</span></span><span style=display:flex><span>                current_app: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                app_start,
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>初始化的逻辑很简单，就是找到<code>link_app.S</code>中提供的符号<code>_num_app</code>，并从这里解析出应用数量以及各个应用的起始地址。</p><p>这里使用了外部库<code>lazy_static</code>提供的<code>lazy_static!</code>宏。引入这个外部库，需要加入依赖：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/Cargo.toml
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>[dependencies]
</span></span><span style=display:flex><span>lazy_static <span style=color:#f92672>=</span> { version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.4.0&#34;</span>, features <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;spin_no_std&#34;</span>] }
</span></span></code></pre></td></tr></table></div></div><p><code>lazy_static!</code>宏提供了全局变量的运行时初始化功能。一般情况下，全局变量必须在编译时设置一个初始值，但是有些全局变量依赖与运行期间才能得到的数据作为初始值。这导致这些全局变量需要在运行时发生变化，即需要重新设置初始值之后才能使用。如果我们手动实现，需要把这种全局变量声明为<code>static mut</code>并衍生出很多unsafe代码。这里借助<code>lazy_static!</code>声明一个<code>AppManager</code>结构的名为<code>APP_NAMAGER</code>的全局实例，且只有在它第一次被使用到的时候，才会进行实际的初始化工作。</p><p>为了满足我们的需求，我们要实现一些<code>AppManager</code>的方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/batch.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> APP_BASE_ADDRESS: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x80400000</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> APP_SIZE_LIMIT: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x20000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> AppManager {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_app_info</span>(<span style=color:#f92672>&amp;</span>self) {
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;[kernel] num_app = {}&#34;</span>, self.num_app);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>..</span>self.num_app {
</span></span><span style=display:flex><span>            println!(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;[kernel] app_{} [{:#x}, {:#x})&#34;</span>,
</span></span><span style=display:flex><span>                i,
</span></span><span style=display:flex><span>                self.app_start[i],
</span></span><span style=display:flex><span>                self.app_start[i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_current_app</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>usize</span> {
</span></span><span style=display:flex><span>        self.current_app
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>move_to_next_app</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        self.current_app <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>load_app</span>(<span style=color:#f92672>&amp;</span>self, app_id: <span style=color:#66d9ef>usize</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> app_id <span style=color:#f92672>&gt;=</span> self.num_app {
</span></span><span style=display:flex><span>            panic!(<span style=color:#e6db74>&#34;All applications completed!&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;[kernel] Loading app_{}&#34;</span>, app_id);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// clear icache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        asm!(<span style=color:#e6db74>&#34;fence.i&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//clear app area
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        core::slice::from_raw_parts_mut(APP_BASE_ADDRESS <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> <span style=color:#66d9ef>u8</span>, APP_SIZE_LIMIT).fill(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> app_src <span style=color:#f92672>=</span> core::slice::from_raw_parts(
</span></span><span style=display:flex><span>            self.app_start[app_id] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>            self.app_start[app_id <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> self.app_start[app_id],
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> app_dst <span style=color:#f92672>=</span> core::slice::from_raw_parts_mut(APP_BASE_ADDRESS <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> <span style=color:#66d9ef>u8</span>, app_src.len());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        app_dst.copy_from_slice(app_src);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>load_app</code>方法，负责将参数<code>app_id</code>对应的应用程序的二进制镜像加载到物理内存以<code>0x80400000</code>起始的位置，这个位置是批处理操作系统和应用程序之间约定的常数地址，在之前我们也调整应用程序的内存布局以同一个地址开头。第36行开始，我们首先将一块内存清空，然后找到待加载应用二进制镜像的位置，并将它复制到正确的位置。它的本质就是将数据从一块内存复制到另一块内存，而从批处理操作系统的角度来看，是将操作系统数据段的一部分数据复制到了一个可以执行代码的内存区域。体现了冯诺伊曼计算机的<em>代码即数据</em>的特征。</p><p>第34行插入了一条汇编指令<code>fence.i</code>，它是用来清除<code>i-cache</code>的。我们知道缓存是存储级结构中提高访存速度很重要的一环。而CPU对物理内存所做的缓存有分为<strong>数据缓存</strong>(d-cache)和<strong>指令缓存</strong>(i-cache)两部分，分别在CPU访存和取指时使用。在取指时，对于一个指令地址，CPU会先去i-cache里面查看它是否在某个已缓存的缓存行内，如果在的话它就会直接从高速缓存中拿到指令而不是通过总线访问内存。通常情况下，CPU 会认为程序的代码段不会发生变化，因此 i-cache 是一种只读缓存。但在这里，OS将修改会被 CPU 取指的内存区域，这会使得 i-cache 中含有与内存中不一致的内容。因此OS在这里必须使用<code>fence.i</code>指令手动清空i-cache，让里面所有的内容全部失效，才能够保证CPU访问内存数据和代码的正确性。</p><h2 id=实现特权级的切换>实现特权级的切换<a hidden class=anchor aria-hidden=true href=#实现特权级的切换>#</a></h2><p>由于处理器具有硬件级的特权级机制，应用程序在用户态特权级运行时，是无法直接通过函数调用访问处于内核态特权级的批处理操作系统内核中的函数。但应用程序又需要得到操作系统提供的服务，所以应用程序和操作系统需要通过某种合作机制完成特权级之间的切换，使得用户态应用程序可以得到内核态操作系统函数的服务。接下来将在RISC-V64处理器提供的U/S特权级下，解决批处理操作系统和应用程序的相互配合，完成特权级切换。</p><h3 id=risc-v特权级切换>RISC-V特权级切换<a hidden class=anchor aria-hidden=true href=#risc-v特权级切换>#</a></h3><h4 id=特权级切换的起因>特权级切换的起因<a hidden class=anchor aria-hidden=true href=#特权级切换的起因>#</a></h4><p>批处理操作系统被设计为运行在内核态特权级，这是作为SEE的RustSBI保证的。而应用程序被设计为运行在用户态特权级，被操作系统为核心的执行环境监督起来。在本篇中，应用程序的执行环境则是批处理系统提供的AEE(Application Execution Environment)。批处理操作系统为了建立好应用程序的执行环境，需要在执行应用之前进行一些初始化工作，并监控应用程序的执行，具体体现在：</p><ul><li>当应用程序被启动时，需要初始化应用程序的用户态上下文，并能切换到用户态执行应用程序</li><li>当应用程序发起系统调用之后，需要到批处理操作系统中进行处理</li><li>当应用程序执行出错时，需要到批处理系统中杀死该应用并加载运行下一个应用</li><li>当应用程序执行结束时，需要到批处理操作系统中加载运行下一个应用</li></ul><p>这些处理都涉及到特权级切换，因此需要应用程序、操作系统和硬件一起协同，完成特权级切换机制。</p><h4 id=特权级切换相关的控制状态寄存器>特权级切换相关的控制状态寄存器<a hidden class=anchor aria-hidden=true href=#特权级切换相关的控制状态寄存器>#</a></h4><p>当从一般意义上讨论RISC-V架构的Trap机制时，通常需要注意两点：</p><ul><li>在触发Trap之前CPU运行在哪个特权级</li><li>CPU需要切换到哪个特权级来处理该Trap，并在处理完成之后返回原特权级</li></ul><p>在本篇中，我们仅考虑如下流程：当CPU在用户态特权级运行应用程序，执行到Trap，切换到内核态特权级，批处理操作系统的对应代码相应Trap，并执行系统调用服务，处理完毕后，从内核态返回到用户态应用程序继续执行后续指令。</p><p>在RISC-V架构中，关于Trap有一条重要规则：在Trap前的特权级不会高于Trap后的特权级。因此如果触发Trap之后切换到S特权级，说明Trap发生之前CPU只能运行在S/U特权级。但无论如何，只要Trap到S特权级，操作系统就会使用S特权级中与Trap相关的<strong>控制状态寄存器</strong>(CSR)来辅助Trap处理。进入S特权级Trap的相关CSR：</p><table><thead><tr><th style=text-align:center>CSR名</th><th style=text-align:center>该CSR与Trap相关的功能</th></tr></thead><tbody><tr><td style=text-align:center>sstatus</td><td style=text-align:center><code>spp</code>等字段给出Trap发生之前CPU处在哪个特权级等信息</td></tr><tr><td style=text-align:center>sepc</td><td style=text-align:center>当Trap是一个异常时，记录Trap发生之前执行的最后一条指令的地址</td></tr><tr><td style=text-align:center>scause</td><td style=text-align:center>描述Trap的原因</td></tr><tr><td style=text-align:center>stval</td><td style=text-align:center>给出Trap附加信息</td></tr><tr><td style=text-align:center>stvec</td><td style=text-align:center>控制Trap处理代码的入口地址</td></tr></tbody></table><h4 id=特权级切换>特权级切换<a hidden class=anchor aria-hidden=true href=#特权级切换>#</a></h4><p>当执行一条Trap类指令，如<code>ecall</code>时，CPU发现触发了一个异常并需要进行特殊处理，这涉及到执行环境切换。应用程序被切换回来之后需要从发出系统调用请求的执行位置恢复应用程序上下文并继续执行，这需要在切换前后维持应用程序的上下文保持不变。应用程序的上下文包括通用寄存器和栈两个主要部分。由于CPU在不同特权级下共享一套通用寄存器，所以在运行操作系统的Trap操作过程中，操作系统也会用到这些寄存器，这会改变应用程序的上下文。因此，与函数调用需要保存函数调用上下文/活动记录一样，在执行操作系统的Trap处理过程之前，我们需要在某个地方保存这些寄存器并在Trap处理结束后恢复这些寄存器。</p><p>除了通用寄存器之外还有一些可能在处理Trap过程中会被修改的CSR，比如CPU所在的特权级。我们要保证它们的变化在我们的预期之内。比如，对特权级转换而言，应该是Trap之前在U特权级，处理Trap的时候在S特权级，返回之后又需要回到U特权级。而对于栈问题则相对简单，只要两个应用程序执行过程中用来记录执行历史的栈所对应的内存区域不想交，就不会产生令我们头痛的覆盖问题和数据破坏问题，也就无需进行保存/恢复。</p><p>特权级切换的具体过程一部分由硬件直接完成，另一部分则需要由操作系统来实现。</p><h3 id=特权级切换的硬件控制机制>特权级切换的硬件控制机制<a hidden class=anchor aria-hidden=true href=#特权级切换的硬件控制机制>#</a></h3><p>当CPU执行完一条指令(例如:<code>ecall</code>)并准备从用户特权级Trap到S特权级时，硬件会自动完成以下事情：</p><ul><li><code>sstatus</code>的<code>SPP</code>字段会被修改为CPU当前特权级</li><li><code>spec</code>会被修改为Trap处理完成后默认会执行的下一条指令的地址</li><li><code>scause/stval</code>分别会被修改成这次Trap的原因以及相关附加信息</li><li>CPU会跳转到<code>stvec</code>所设置的Trap处理入口地址，并将当前特权级设置为S，然后从Trap处理入口地址开始执行</li></ul><p>而当CPU完成Trap处理准备返回的时候，需要通过一条S特权级的特权指令<code>sret</code>来完成，这一条指令具体完成以下功能：</p><ul><li>CPU会将当前的特权级按照<code>sstatus</code>的<code>SPP</code>字段设置为U或者S</li><li>CPU会跳转到<code>spec</code>寄存器指向那条指令，然后继续执行</li></ul><h3 id=用户栈与内存栈>用户栈与内存栈<a hidden class=anchor aria-hidden=true href=#用户栈与内存栈>#</a></h3><p>在Trap触发的一瞬间，CPU就会切换到S特权级并跳转到<code>stvec </code>所指示的位置。但是在正式进入S特权级的Trap之前，上面提到过我们必须保存原控制流的寄存器转台，这一般通过内核栈来保存。注意，我们需要用专门为操作系统准备的内核栈，而非应用程序运行时用到的用户栈。</p><p>使用两个不同的栈主要是为了安全性：如果两个控制流使用同一个栈，在返回之后应用程序就能读到Trap控制流的历史信息，比如内核一些函数的地址，这样会带来安全隐患。于是，我们要做的事，在批处理操作系统中添加一段汇编代码，实现从用户栈切换到内核栈，并在内核栈上保存应用程序控制流的寄存器状态。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/batch.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> KERNEL_STACK_SIZE: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4096</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> USER_STACK_SIZE: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4096</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> KERNEL_STACK: <span style=color:#a6e22e>KernelStack</span> <span style=color:#f92672>=</span> KernelStack {
</span></span><span style=display:flex><span>    data: [<span style=color:#ae81ff>0</span>; KERNEL_STACK_SIZE],
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> USER_STACK: <span style=color:#a6e22e>UserStack</span> <span style=color:#f92672>=</span> UserStack {
</span></span><span style=display:flex><span>    data: [<span style=color:#ae81ff>0</span>; USER_STACK_SIZE],
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[repr(align(4096))]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>KernelStack</span> {
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; KERNEL_STACK_SIZE],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[repr(align(4096))]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>UserStack</span> {
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; USER_STACK_SIZE],
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>KERNEL_STACK_SIZE</code>和<code>USER_STACK_SIZE</code>指出内核栈和用户栈道大小分别为$8KiB$。两个类型是以全局变量的形式实例化在批处理操作系统的<code>.bss</code>段中的。</p><p>我们为两个类型实现了<code>get_sp</code>方法来获取栈顶地址。由于RISC-V中栈是向下增长的，我们只需返回包裹的数组的结尾地址：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/batch.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>impl</span> KernelStack {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_sp</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>usize</span> {
</span></span><span style=display:flex><span>        self.data.as_ptr() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span> <span style=color:#f92672>+</span> KERNEL_STACK_SIZE
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> UserStack {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_sp</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>usize</span> {
</span></span><span style=display:flex><span>        self.data.as_ptr() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span> <span style=color:#f92672>+</span> USER_STACK_SIZE
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>于是换栈是非常简单的，只需将<code>sp</code>寄存器的值修改为<code>get_sp</code>的返回值即可。</p><p>接下来是Trap上下文，类似前面提到的函数调用上下文，即在Trap发生时需要保存的物力资源内容，并将其放在一个名为<code>TrapContext</code>的类型中，定义如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/trap/context.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> riscv::register::sstatus::Sstatus;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[repr(C)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TrapContext</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> x: [<span style=color:#66d9ef>usize</span>; <span style=color:#ae81ff>32</span>],
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> sstatus: <span style=color:#a6e22e>Sstatus</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> sepc: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看到里面包含所有的通用寄存器<code>x0~x31</code>，还有<code>sstatuc</code>和<code>spec</code>。为什么保存它们呢？</p><ul><li>对于通用寄存器而言，两条控制流运行在不同的特权级，所属的软件也可能由不同的编程语言编写，虽然在Trap控制流中只是会执行Trap处理相关的代码，但依然可以直接或间接调用很多模块，因此很难甚至不可能找出哪些寄存器无需保存，既然如此只能全部保存。但也有一些例外，<code>x0</code>被硬编码成0，它自然不会有变化，还有<code>tp(x4)</code>寄存器，除非我们手动处于一些特殊用途使用它，否则一般也不会被用到。它们虽然无需被保存，但我们仍然为其预留空间，主要是为了后续的实现方便。</li><li>对于CSR而言，我们知道进入Trap的时候，硬件会立即覆盖掉<code>scause/stval/sstatus/sepc</code>的全部或是其中一部分。<code>scause/stval</code>的情况是：它总是被Trap处理的第一时间就被使用或者在其他地方保存下来了，因此它没有被修改并造成不良影响的风险。而对于<code>sstatus/sepc</code>而言，它们会在Trap处理的全程有意义（在Trap控制流最后<code>sret</code>的时候还用到了它们），而且确实会出现Trap嵌套的情况使得它们的值被覆盖掉。所以我们需要将它们保存下来，并在<code>sret</code>之前恢复原样。</li></ul><h3 id=trap管理>Trap管理<a hidden class=anchor aria-hidden=true href=#trap管理>#</a></h3><p>特权级切换的核心是对Trap的管理。主要涉及如下一些内容：</p><ul><li>应用程序通过<code>ecall</code>进入到内核状态时，操作系统保存被打断的应用程序的Trap上下文</li><li>操作系统根据Trap相关的CSR寄存器内容，完成系统调用服务的分发与处理</li><li>操作系统完成系统调用服务后，需要恢复被打断的应用程序的Trap上下文，并通过<code>sret</code>让应用程序继续执行</li></ul><h4 id=trap上下文的保存与恢复>Trap上下文的保存与恢复<a hidden class=anchor aria-hidden=true href=#trap上下文的保存与恢复>#</a></h4><p>首先是具体实现Trap上下文保存和恢复的汇编代码，在批处理操作系统初始化的时候，我们需要修改<code>stvec</code>寄存器来指向正确的Trap处理入口点：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/trap/mod.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>use</span> core::arch::global_asm;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> riscv::register::{mtvec::TrapMode, stvec};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_asm!(include_str!(<span style=color:#e6db74>&#34;trap.S&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>__alltraps</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        stvec::write(__alltraps <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>, TrapMode::Direct);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里我们引入了一个外部符号<code>__alltraps</code>，并将<code>stvec</code>设置为Direct模式指向它的地址。我们在<code>os/src/trap/trap.S</code>中实现Trap上下文保存/恢复的汇编代码，分别用外部符号<code>__alltraps</code>和<code>__restore</code>标记为函数，并通过<code>global_asm!</code>宏将这段汇编代码插入进来。</p><p>Trap处理的总体流程如下：首先通过<code>__alltraps</code>将Trap上下文保存在内核栈上，然后跳转到使用Rust编写的<code>trap_handler</code>函数完成Trap分发及处理。当<code>trap_handler</code>返回之后，使用<code>__restore</code>从保存在内核栈上的Trap上下文恢复寄存器。最后通过<code>sret</code>指令回到应用程序执行。</p><p>首先是保存Trap上下文的<code>__alltraps</code>的实现：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># os/src/trap/trap.S
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.macro SAVE_GP n
</span></span><span style=display:flex><span>    ld x\n, \n*8(sp)
</span></span><span style=display:flex><span>.endm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.align 2
</span></span><span style=display:flex><span>__alltraps:
</span></span><span style=display:flex><span>    csrrw sp, sscratch, sp
</span></span><span style=display:flex><span>    # now sp-&gt;kernel stack, sscratch-&gt;user stack
</span></span><span style=display:flex><span>    # allocate a TrapContext on kernel stack
</span></span><span style=display:flex><span>    addi sp, sp, -34*8
</span></span><span style=display:flex><span>    # save general-purpose registers
</span></span><span style=display:flex><span>    sd x1, 1*8(sp)
</span></span><span style=display:flex><span>    # skip sp(x2), we will save it later
</span></span><span style=display:flex><span>    sd x3, 3*8(sp)
</span></span><span style=display:flex><span>    # skip tp(x4), application does not use it
</span></span><span style=display:flex><span>    # save x5~x31
</span></span><span style=display:flex><span>    .set n, 5
</span></span><span style=display:flex><span>    .rept 27
</span></span><span style=display:flex><span>        SAVE_GP %n
</span></span><span style=display:flex><span>        .set n, n+1
</span></span><span style=display:flex><span>    .endr
</span></span><span style=display:flex><span>    # we can use t0/t1/t2 freely, because they were saved on kernel stack
</span></span><span style=display:flex><span>    csrr t0, sstatus
</span></span><span style=display:flex><span>    csrr t1, sepc
</span></span><span style=display:flex><span>    sd t0, 32*8(sp)
</span></span><span style=display:flex><span>    sd t1, 33*8(sp)
</span></span><span style=display:flex><span>    # read user stack from sscratch and save it on the kernel stack
</span></span><span style=display:flex><span>    csrr t2, sscratch
</span></span><span style=display:flex><span>    sd t2, 2*8(sp)
</span></span><span style=display:flex><span>    # set input argument of trap_handler(cx: &amp;mut TrapContext)
</span></span><span style=display:flex><span>    mv a0, sp
</span></span><span style=display:flex><span>    call trap_handler
</span></span></code></pre></td></tr></table></div></div><ul><li>第7行我们使用<code>.align</code>将<code>__alltraps</code>的地址4字节对齐，这是RISC-V特权级规范的要求</li><li>第9行的<code>csrrw</code>原型是<code>csrrw rd, csr, rs</code>，可以将CSR当前的值读到通用寄存器<code>rd</code>中，然后将通用寄存器<code>rs</code>的值写入该CSR。因此这里起到的是交换<code>sscratch</code>和<code>sp</code>的效果。在这一行之前<code>sp</code>指向用户栈，<code>sscratch</code>指向内核栈，之后<code>sp</code>指向内核栈，<code>sscratch</code>指向用户栈</li><li>第12行，我们准备在内核栈上保存Trap上下文，于是预先分配$34 \times 8$字节的栈帧，这里改动的是<code>sp</code>，说明确实是在内核栈上</li><li>第13～24行，保存Trap上下文的通用寄存器<code>x0~x31</code>，跳过<code>x0</code>和<code>tp(x4)</code>，原因之前已经说明。在这里也无需保存<code>sp(x2)</code>，因为我们要基于它来找到每个寄存器应该被保存到的正确的位置。实际上，在栈帧分配之后，我们可用于保存Trap上下文的地址区间为$[sp, sp+8 \times 34)$，按照<code>TrapContext</code>结构体的内存布局，基于内核栈道位置(sp所指向的地址)来从低地址到高地址分别按顺序放置<code>x0~x31</code>这些通用寄存器，最后是<code>sstatus</code>和<code>sepc</code>。因此通用寄存器<code>xn</code>应该被保存在地址区间$[sp+8n,sp+8(n+1))$。为了简化代码，<code>x5~x31</code>这27个通用寄存器我们通过类似循环的<code>.rept</code>每次使用<code>SAVE_GP</code>宏来保存，其实质是相同的。注意我们需要在<code>trap.S</code>开头加上<code>.altmacro</code>才能正确使用<code>.rept</code>命令</li><li>第25～28行，将CSR <code>sstatus</code>和<code>sepc</code>的值分别读到寄存器<code>t0</code>和<code>t1</code>中然后保存到内核栈对应的位置上。指令<code>csrr rd, csr</code>功能就是将CSR的值读到寄存器<code>rd</code>中</li><li>第30～31行专门处理sp的问题。首先将<code>sscratch</code>的值读取到寄存器<code>t2</code>并保存到内核栈上。注意：此时<code>sscratch</code>指向用户栈，<code>sp</code>指向内核栈</li><li>第33行令<code>a0&lt;-sp</code>，让寄存器<code>a0</code>指向内核栈的栈指针也就是我们刚刚保存的Trap上下文的地址，这是由于我们接下来调用<code>trap_handler</code>进行Trap处理，它的第一个参数<code>cx</code>由调用规范要从<code>a0</code>中获取。而Trap处理函数<code>trap_handler</code>需要Trap上下文的原因在于：它需要知道其中某些寄存器的值，比如在系统调用的时候应用程序传过来的syscall ID和对应参数。</li></ul><p>当<code>trap_handler</code>返回之后会从调用<code>trap_handler</code>的下一条指令开始执行，也就是从栈上的Trap上下文恢复的<code>__restore</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># os/src/trap/trap.S
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.macro LOAD_GP n
</span></span><span style=display:flex><span>    ld x\n, \n*8(sp)
</span></span><span style=display:flex><span>.endm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__restore:
</span></span><span style=display:flex><span>    # case1: start running app by __restore
</span></span><span style=display:flex><span>    # case2: back to U after handling trap
</span></span><span style=display:flex><span>    mv sp, a0
</span></span><span style=display:flex><span>    # now sp-&gt;kernel stack(after allocated), sscratch-&gt;user stack
</span></span><span style=display:flex><span>    # restore sstatus/sepc
</span></span><span style=display:flex><span>    ld t0, 32*8(sp)
</span></span><span style=display:flex><span>    ld t1, 33*8(sp)
</span></span><span style=display:flex><span>    ld t2, 2*8(sp)
</span></span><span style=display:flex><span>    csrw sstatus, t0
</span></span><span style=display:flex><span>    csrw sepc, t1
</span></span><span style=display:flex><span>    csrw sscratch, t2
</span></span><span style=display:flex><span>    # restore general-purpuse registers except sp/tp
</span></span><span style=display:flex><span>    ld x1, 1*8(sp)
</span></span><span style=display:flex><span>    ld x3, 3*8(sp)
</span></span><span style=display:flex><span>    .set n, 5
</span></span><span style=display:flex><span>    .rept 27
</span></span><span style=display:flex><span>        LOAD_GP %n
</span></span><span style=display:flex><span>        .set n, n+1
</span></span><span style=display:flex><span>    .endr
</span></span><span style=display:flex><span>    # release TrapContext on kernel stack
</span></span><span style=display:flex><span>    addi sp, sp, 34*8
</span></span><span style=display:flex><span>    # now sp-&gt;kernel stack, sscratch-&gt;user stack
</span></span><span style=display:flex><span>    csrrw sp, sscratch, sp
</span></span><span style=display:flex><span>    sret
</span></span></code></pre></td></tr></table></div></div><ul><li>第13～26行负责从内核栈顶的Trap上下文恢复通用寄存器和CSR。我们要先恢复CSR再恢复通用寄存器，这样我们使用的三个临时寄存器才能被正确恢复</li><li>在第28行之前，<code>sp</code>指向保存了Trap上下文之后的内核栈栈顶，<code>sscratch</code>指向用户栈栈顶。在第28行内核栈上回收Trap上下文所占用的内存，回归进入Trap之前的内核栈栈顶。第30行，再次交换<code>sscratch</code>和<code>sp</code>，现在<code>sp</code>重新只想用户栈栈顶，<code>sscratch</code>也依然保存进入Trap之前的状态并指向内核栈栈顶</li><li>在应用程序控制流状态会还原之后，第31行使用<code>sret</code>指令回到U特权级继续运行应用程序控制流</li></ul><h4 id=trap分发与处理>Trap分发与处理<a hidden class=anchor aria-hidden=true href=#trap分发与处理>#</a></h4><p>Trap在使用Rust实现的<code>trap_handler</code>函数中完成分发和处理：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/trap/mod.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[no_mangle]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>trap_handler</span>(cx: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> TrapContext) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> TrapContext {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> scause <span style=color:#f92672>=</span> scause::read();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stval <span style=color:#f92672>=</span> stval::read();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> scause.cause() {
</span></span><span style=display:flex><span>        Trap::Exception(Exception::UserEnvCall) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            cx.sepc <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>            cx.x[<span style=color:#ae81ff>10</span>] <span style=color:#f92672>=</span> syscall(cx.x[<span style=color:#ae81ff>17</span>], [cx.x[<span style=color:#ae81ff>10</span>], cx.x[<span style=color:#ae81ff>11</span>], cx.x[<span style=color:#ae81ff>12</span>]]) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        Trap::Exception(Exception::StoreFault) <span style=color:#f92672>|</span> Trap::Exception(Exception::StorePageFault) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            println!(<span style=color:#e6db74>&#34;[kernel] PageFault in application, kernel killed it.&#34;</span>);
</span></span><span style=display:flex><span>            run_next_app();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        Trap::Exception(Exception::IllegalInstruction) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            println!(<span style=color:#e6db74>&#34;[kernel] IllegalInstruction in application, kernel killed it.&#34;</span>);
</span></span><span style=display:flex><span>            run_next_app();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        _ <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            panic!(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Unsupported trap {:?}, stval = {:#x}&#34;</span>,
</span></span><span style=display:flex><span>                scause.cause(),
</span></span><span style=display:flex><span>                stval
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    cx
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>第4行声明返回值为<code>&mut TrapContext</code>并在第28行将传入的Trap上下文<code>cx</code>原样返回，因此在<code>__restore</code>的时候<code>a0</code>寄存器在调用<code>trap_handler</code>前后并没有发生变化，仍然指向分配Trap上下文之后的内核栈栈顶，和此时<code>sp</code>的值相同，这里的<code>sp&lt;-a0</code>并不会有问题</p></li><li><p>第7行根据<code>scause</code>寄存器所保存的Trap的原因进行分发处理。这里我们无须手动操作这些CSR，而是使用Rust的riscv库来更加方便的操作。引入riscv库，需要在<code>os/Cargo.toml</code>中添加：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># os/Cargo.toml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>dependencies</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>riscv</span> = { <span style=color:#a6e22e>git</span> = <span style=color:#e6db74>&#34;https://github.com/rcore-os/riscv&#34;</span>, <span style=color:#a6e22e>features</span> = [<span style=color:#e6db74>&#34;inline-asm&#34;</span>] }
</span></span></code></pre></td></tr></table></div></div></li><li><p>第8～11行，发现触发Trap的原因是来自于U特权级的Environment Call，也就是系统调用。这里我们首先修改保存在内核栈上的Trap上下文里面<code>sepc</code>，让其增加4。这是因为我们知道这是一个由<code>ecall</code>指令触发的系统调用，在进入Trap的时候，硬件会将<code>sepc</code>设置为这条<code>ecall</code>指令所在的地址。而在Trap返回之后，我们希望应用程序控制流从<code>ecall</code>的下一条指令开始执行。因此我们只需修改Trap上下文里面的<code>sepc</code>，让他增加<code>ecall</code>指令的码长，即4字节。这样在<code>__restore</code>的时候<code>sepc</code>在恢复之后就会指向<code>ecall</code>的下一条指令，并在<code>sret</code>之后从这里开始执行。</p><p>用来保存系统调用返回值的<code>a0</code>寄存器也会同样发生变化。我们从Trap上下文取出作为syscall ID的<code>a7</code>和系统调用的三个参数`</p></li><li><p>第12～19行，分别处理应用程序出现访存错误和非法指令错误的情况。此时需要打印错误信息并调用<code>run_next_app</code>直接切换并运行下一个应用程序。</p></li><li><p>第20行开始，当遇到目前还不支持的Trap类型的时候，批处理操作系统整个panic报错退出。</p></li></ul><h3 id=实现系统调用功能>实现系统调用功能<a hidden class=anchor aria-hidden=true href=#实现系统调用功能>#</a></h3><p>对于系统调用而言，<code>syscall</code>函数并不会实际处理系统调用，而只是根据syscall ID分发到具体的处理函数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/syscall/mod.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> SYSCALL_WRITE: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>64</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> SYSCALL_EXIT: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>93</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>syscall</span>(syscall_id: <span style=color:#66d9ef>usize</span>, args: [<span style=color:#66d9ef>usize</span>; <span style=color:#ae81ff>3</span>]) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> syscall_id {
</span></span><span style=display:flex><span>        SYSCALL_WRITE <span style=color:#f92672>=&gt;</span> sys_write(args[<span style=color:#ae81ff>0</span>], args[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>u8</span>, args[<span style=color:#ae81ff>2</span>]),
</span></span><span style=display:flex><span>        SYSCALL_EXIT <span style=color:#f92672>=&gt;</span> sys_exit(args[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>i32</span>),
</span></span><span style=display:flex><span>        _ <span style=color:#f92672>=&gt;</span> panic!(<span style=color:#e6db74>&#34;Unsupported syscall_id: {}&#34;</span>, syscall_id),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里我们会将传进来的参数<code>args</code>转化成能够被具体的系统调用处理函数接受的类型：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/syscall/fs.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> FD_STDOUT: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sys_write</span>(fd: <span style=color:#66d9ef>usize</span>, buf: <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>u8</span>, len: <span style=color:#66d9ef>usize</span>) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> fd {
</span></span><span style=display:flex><span>        FD_STDOUT <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> slice <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { core::slice::from_raw_parts(buf, len) };
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> core::<span style=color:#66d9ef>str</span>::from_utf8(slice).unwrap();
</span></span><span style=display:flex><span>            print!(<span style=color:#e6db74>&#34;{}&#34;</span>, <span style=color:#66d9ef>str</span>);
</span></span><span style=display:flex><span>            len <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>isize</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        _ <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            panic!(<span style=color:#e6db74>&#34;Unsupported fd in sys_write!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/syscall/process/rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>sys_exit</span>(exit_code: <span style=color:#66d9ef>i32</span>) -&gt; <span style=color:#f92672>!</span> {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;[kernel] Application exited with code {}&#34;</span>, exit_code);
</span></span><span style=display:flex><span>    run_next_app()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><code>sys_write</code>我们将传入的位于应用程序内的缓冲区的开始地址和长度转化成一个字符串<code>&str</code>，然后使用批处理操作系统已经实现的<code>print!</code>宏打印出来。</li><li><code>sys_exit</code>打印退出的应用程序的返回值并同样调用<code>run_next_app</code>切换到下一个应用程序。</li></ul><h3 id=执行应用程序>执行应用程序<a hidden class=anchor aria-hidden=true href=#执行应用程序>#</a></h3><p>当批处理操作系统初始化完成，或者是某个应用运行结束或出错的时候，我们要调用<code>run_next_app</code>函数切换到下一个应用程序。此时CPU运行在S特权级，而它希望能切换到U特权级。在RISC-V架构中，唯一一种使得CPU特权级下降的方法就是执行Trap返回到特权指令，如<code>sret</code>、<code>mret</code>等。事实上，在从操作系统内核返回到运行应用程序之前，要完成如下这些工作：</p><ul><li>构造应用程序开始执行所需要的Trap上下文</li><li>通过<code>__restore</code>函数，从刚构造的Trap上下文中，恢复应用程序执行的部分寄存器</li><li>设置<code>sepc</code>CSR的内容为应用程序入口点<code>0x80400000</code></li><li>切换<code>scratch</code>和<code>sp</code>寄存器，设置<code>sp</code>指向应用程序用户栈</li><li>执行<code>sret</code>从S特权级切换到U特权级</li></ul><p>它们可以通过复用<code>__restore</code>的代码来更容易的实现上述工作。我们只需要在内核栈上压入一个为启动应用程序而特殊构造的Trap上下文，在通过<code>__restore</code>函数，就能让这些寄存器到达启动应用程序所需要的上下文状态。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/trap/context.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> TrapContext {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>set_sp</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, sp: <span style=color:#66d9ef>usize</span>) {
</span></span><span style=display:flex><span>        self.x[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> sp;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>app_init_context</span>(entry: <span style=color:#66d9ef>usize</span>, sp: <span style=color:#66d9ef>usize</span>) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> sstatus <span style=color:#f92672>=</span> sstatus::read();
</span></span><span style=display:flex><span>        sstatus.set_spp(SPP::User);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> cx <span style=color:#f92672>=</span> Self {
</span></span><span style=display:flex><span>            x: [<span style=color:#ae81ff>0</span>; <span style=color:#ae81ff>32</span>],
</span></span><span style=display:flex><span>            sstatus,
</span></span><span style=display:flex><span>            sepc: <span style=color:#a6e22e>entry</span>,
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        cx.set_sp(sp);
</span></span><span style=display:flex><span>        cx
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>为<code>TrapContext</code>实现<code>app_init_context</code>方法，修改其中的<code>sepc</code>寄存器为应用程序入口点<code>entry</code>，<code>sp</code>寄存器为我们设定的一个栈指针，并将<code>sstatus</code>寄存器的<code>SPP</code>字段设置为User。</p><p>在<code>run_next_app</code>函数中我们能够看到：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// os/src/batch.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>run_next_app</span>() -&gt; <span style=color:#f92672>!</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> app_manager <span style=color:#f92672>=</span> APP_MANAGER.exclusive_access();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> current_app <span style=color:#f92672>=</span> app_manager.get_current_app();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        app_manager.load_app(current_app);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    app_manager.move_to_next_app();
</span></span><span style=display:flex><span>    drop(app_manager);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>__restore</span>(cx_addr: <span style=color:#66d9ef>usize</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        __restore(KERNEL_STACK.push_context(TrapContext::app_init_context(
</span></span><span style=display:flex><span>            APP_BASE_ADDRESS,
</span></span><span style=display:flex><span>            USER_STACK.get_sp(),
</span></span><span style=display:flex><span>        )) <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _ <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    panic!(<span style=color:#e6db74>&#34;Unreachable in batch::run_current_app!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在17～22行所做的事情就是在内核栈上压入一个Trap上下文，其<code>sepc</code>是应用程序入口<code>0x80400000</code> ，其<code>sp</code>寄存器指向用户栈，其<code>sstatus</code>的<code>SPP</code>字段被设置为User。<code>push_context</code>的返回值是内核栈压入Trap上下文之后的栈顶，它会被作为<code>__restore</code>的参数，这使得在<code>__restore</code>函数中<code>sp</code>仍然可以指向内核栈道栈顶。这之后，就和执行一次普通的<code>__restore</code>函数调用一样了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.niuwx.cn/tags/rcore/>rCore</a></li></ul><nav class=paginav><a class=next href=https://www.niuwx.cn/posts/rcore/os1/><span class=title>Next Page »</span><br><span>rCore-os1-应用程序与基本执行环境</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share rCore-os2-批处理系统 on twitter" href="https://twitter.com/intent/tweet/?text=rCore-os2-%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f&url=https%3a%2f%2fwww.niuwx.cn%2fposts%2frcore%2fos2%2f&hashtags=rCore"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share rCore-os2-批处理系统 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.niuwx.cn%2fposts%2frcore%2fos2%2f&title=rCore-os2-%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f&summary=rCore-os2-%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f&source=https%3a%2f%2fwww.niuwx.cn%2fposts%2frcore%2fos2%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share rCore-os2-批处理系统 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.niuwx.cn%2fposts%2frcore%2fos2%2f&title=rCore-os2-%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share rCore-os2-批处理系统 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.niuwx.cn%2fposts%2frcore%2fos2%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share rCore-os2-批处理系统 on whatsapp" href="https://api.whatsapp.com/send?text=rCore-os2-%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f%20-%20https%3a%2f%2fwww.niuwx.cn%2fposts%2frcore%2fos2%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share rCore-os2-批处理系统 on telegram" href="https://telegram.me/share/url?text=rCore-os2-%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f&url=https%3a%2f%2fwww.niuwx.cn%2fposts%2frcore%2fos2%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script>var gitalk=new Gitalk({clientID:"020fa7d4d09265f4eb67",clientSecret:"29db217eaf1173794064f0e5bb3fa87004d111ba",repo:"isther.github.io",owner:"isther",admin:["isther"],id:location.pathname,distractionFreeMode:!1});gitalk.render("gitalk-container")</script></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.niuwx.cn/>Ther's Blog -- 个人笔记</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
<a href=https://beian.miit.gov.cn/ rel=noopener target=_blank>晋ICP备2020009882号-1</a></span>
<script type=text/javascript>document.write(unescape("%3Cspan id='cnzz_stat_icon_1279768046'%3E%3C/span%3E%3Cscript src='https://s4.cnzz.com/z_stat.php%3Fid%3D1279768046%26online%3D2' type='text/javascript'%3E%3C/script%3E"))</script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>